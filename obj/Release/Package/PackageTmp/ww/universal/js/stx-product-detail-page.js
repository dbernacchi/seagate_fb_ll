//this function includes all necessary js files for the application
function includeScript(srcPath,idVar)
{

  var script  = document.createElement('script');
  script.src  = srcPath;
  script.type = 'text/javascript';
  script.defer = true;
  document.getElementById(idVar).appendChild(script);
}

function createAccessoriesResellersLinks() {
	var RGID = getRGID(rcLocaleJS, 'embed');
	$('.ciModelNumber').each(function(index) {
		var sku = $(this).text();
		$.getScript("http://seagate.links.channelintelligence.com/scripts/cii_CBL_DataService.asp?sSKU=" + sku + "&nRGID=" + RGID, function() { 
			var ciButtonScript = "cii_ShowCBLButton('" + sku + "', oCIIPrimaryLink, oCIIAlternateLink, " + (index+2) + ", '" + RGID + "', CI_LinkID);";
			var ciButtonScriptOutput = eval(ciButtonScript);
			// If button is returned, build our own HTML for it
			if (ciButtonScriptOutput.length > 0) {
				var ciButtonHTML = "";
				for (var i = 0; i < 3; i++) {
					if (i === 2) {
						ciButtonScriptOutput[i] = ciButtonScriptOutput[i].replace('>',' class="button button-orange">');
					}
					ciButtonHTML += ciButtonScriptOutput[i];
				}
				ciButtonHTML += "<span>" + labels.buy_now + "</span></a>";
				$('.ciModelNumber:contains('+sku+')').parents('.pdp-accessories-buy').find('.ciButton').html(ciButtonHTML);
			}
		});
	});
}

function createAccessoriesResellersLinksRelatedProducts() {
	var RGID = getRGID(rcLocaleJS, 'embed');
	$('div.pdp-related-products-info.hiddenProductId').each(function(index) {
		var $parent = $(this);
		var sku = $(this).data("sku");
		$.getScript("http://seagate.links.channelintelligence.com/scripts/cii_CBL_DataService.asp?sSKU=" + sku + "&nRGID=" + RGID, function() { 
			var ciButtonScript = "cii_ShowCBLButton('" + sku + "', oCIIPrimaryLink, oCIIAlternateLink, " + (index+2) + ", '" + RGID + "', CI_LinkID);";
			var ciButtonScriptOutput = eval(ciButtonScript);
			// If button is returned, build our own HTML for it
			if (ciButtonScriptOutput.length > 0) {
				var ciButtonHTML = "";
				for (var i = 0; i < 3; i++) {
					if (i === 2) {
						ciButtonScriptOutput[i] = ciButtonScriptOutput[i].replace('>',' class="button button-orange button-s">');
					}
					ciButtonHTML += ciButtonScriptOutput[i];
				}
				ciButtonHTML += "<span>" + labels.buy_now + "</span></a>";
				$parent.find('p.pdp-related-products-price').html(ciButtonHTML);
			}
		});
	});
}

/**
 *
 * Description of product_configurator The ProductConfigurator is repsonsible
 * for merging the information from DR with the infomation from VCM and
 * outputting it to the screen. The configurator drives the image gallery on the
 * product page, and narrow or expands the user available options according to
 * her selections. For more detail on what exactly it does please see the
 * Functional Specifications document.
 *
 * The configurator is a jQuery plugin that has 3 major functions and a few
 * additional smaller support functions. I'll cover the 3 main ones in this
 * description as the small ones are support functions and will be summarized in
 * a line or two directly in the function.
 *
 * function intialize() is called only once upon loading the page. It takes the
 * product info from VCM which is stored in the ProdutInfoStruct (PIS) json
 * object on the page and the json object that comes from DR and process them
 * into two arrays. One array of models and one of attributes. The attribute set
 * is a bit different from the attributes in the PIS as it holds additional
 * attributes specific to the presentation of the data rather then just
 * attributes of the product. it then calls the createHtml() function to to
 * build the skeleton of the configuator, and the refilter() which calls the
 * gallery.js and populates the configurator's skeleton with the content of the
 * two arrays.
 *
 * function createHtml () is called only once by the initialize function. It
 * builds the html skeleton for the configurator and populates 3 of its
 * elements: colors, model pop ups and countries for WTB. createHtml uses
 * "labels" extensively. It is an object of strings that gets generated by jsp
 * so that a locale specific set of string is availalbe to work with.
 *
 * refilter() is where all the magic happens. it gets called by initialize and
 * then for every change to the selections moving forwards. The refiilter
 * functions is
 *
 *
 */
 /*var labels = {
	"seagate_direct_home" : "Seagate Direct Home",
	"shop" : "SHOP",
	 "spp_home" : "SPP Home",
	"standart_model" : "Standard Model",
	"select_options" : "Select your model",
	"customize"	   : "Customize",
	"model_numbers"  : "Model Numbers",
	"select_drive"   : "Select Drive",
	"model_number"  : "Model Number",
	"add_to_shortlist": "Add to Shortlist",
	"buy_from_seagate_online" : "Buy from Seagate Online",
	"qty"			: "Qty",
	"comparison_shop" : "Comparison Shop",
	"find_a_distributor" : "Find a Distributor",
	"find_a_store_nearby" : "Find a store nearby",
	"find":"Find",
	"add_to_cart" :"Add to Cart",
	"back_order" : "Back Order",
	"dr_in_stock" :"In Stock",
	"dr_out_of_stock" :"Out of stock",
	"dr_back_order" :"Back-Order",
	"dr_pre_order" :"Pre-Order",
	"back_order_desc" :"Available for Back Order",
       "pre_order_desc" :"Available for Pre Order",
       "pre_order" :"Pre Order",
       "configure_and_buy" :"Configure &amp; Buy",
       "none" :"None",
       "color" :"Color",
	"on_sale" :"On Sale",
	"price"  : "Price",
	"compare_prices"  : "Compare Prices",
	"unitedStates"  : "United States",
	"china"  : "China",
	"compare_prices"  : "Compare Prices",
	"partner_offerings" : "Partner Offerings",
	"buy" : "Buy",
	"buy_now"  : "BUY NOW",
  "not_selected"  : "Model not selected",
  "select_value"  : "Please select a value for each configuration option.",
  "wait_message"  : "Gathering price and purchase options.",
  "not_available_resellers"  : "We’re adding more resellers all the time, try another model or check back soon.",
  "not_available_seagate"  : "We’re fresh out of this model, click Stay Informed so we can let you know when we get more.",
  "more_resellers"  : "Show more Resellers",
	"unitedStates"  : "United States",
	"china"  : "China",
	"japan"  : "Japan",
	"republicofKorea"  : "Republic of Korea",
	"taiwan"  : "Taiwan",
	"germany"  : "Germany",
	"spain"  : "Spain",
	"france"  : "France",
	"italy"  : "Italy",
	"russia"  : "Russia",
	"poland"  : "Poland",
	"turkey"  : "Turkey",
	"Portugal"  : "Portugal",
	"find_a_store_url" : "http://wheretobuy.seagate.com/"
};*/



jQuery.fn.ProductConfigurator = function(method) {
	var options = {
		'url': '',
		'gallery': '#ALGContainer',
		'quick_links': false,
		'tab': {
			title: ''
		},
		'type': {
			title: '',
			img: ''
		},
		'onlybuy': false,
		'compare_url': ''
	};

	var param_clicked = false;
	var default_image_alt = "";
	var default_image_src = "";
	var product_image_alt = "";
	var product_image_src = "";
	var container = $(this);
	var selections = [];
	var attributes = [];
	var models = [];
	var gallery_model_id = null;
	var modelList = [];
	var standart_model_id = null;
	var default_model_id = null;
	var selected_model_id = null;
	var prev_model_number = null;
	var new_selection = null;
	var standard_model_number = null;
	var default_model_number = null;
	var standart_model = false;
	var default_model = false;
	var default_sku_id = null;
	var default_sku_number = null;
	var selected_model = null;
	var single_model = true;
	var single_model_id = null;
	var gallery_models = [];
	var releaseImages = null;
	var foundModels = [];
	var colorCodes = null;
	var allChoosed = true;
	var inAgain = false;
	var withColor = false;
	var displayGallery = false;
	var distiCountry = "US";
	//var locale = $("#localeId").val();
	var locale = rcLocaleJS;
	var lang = locale.substring(0, 2);
	var geog = locale.substring(3, 5);
	var productId = $("#productIds").val();
	var comparisonEnabled = false;
	var hidedisti = false;
	var expanded_configurator = false;
	var in_class = "";
	var disti_to_top = false;
	var wtb_vendors = 0;
	var resellers_var_vendors = 0;
	var wtb_resellers_data = "";
	var wtb_data_country_code = "";
	var stx_store = false;
	//stx_store = true;  //remove
	//var PID = "281182500"; //remove
	var POP = "value-add";
	var RGID = getRGID(locale, "xml");
	var embedRGID = getRGID(locale, 'embed');
	//RGID = "4450";//remove
    //var UserCountryCode = "AU";//remove
    var selectedCountryCode = UserCountryCode; //user country code is in the grid and generated by IP detect.
    var ecomm_locale = getEcommLocale();
	var ecomm_currency = "";
	var dr_locale = "";
	var storeEnabled = true;
	
	if (ProductInfoStruct.releaseList[0].blocks.buyBlock === false) storeEnabled = false;

	if (storeEnabled && ecomm_locale!= "")  stx_store = true;
	if(stx_store){
		for (i = 0; i < ecommLocaleMap.ecommLocalesList.length; i++) {
			if (ecommLocaleMap.ecommLocalesList[i].ecommLocale == ecomm_locale){
				dr_locale = ecommLocaleMap.ecommLocalesList[i].drLocale;
				ecomm_currency = ecommLocaleMap.ecommLocalesList[i].currency;
			}
		}
	}

	
	if (typeof(ProductInfoStruct.releaseList[0].hidedisti) != 'undefined') hidedisti = ProductInfoStruct.releaseList[0].hidedisti;
	if (typeof(ProductInfoStruct.releaseList[0].expanded) != 'undefined') expanded_configurator = ProductInfoStruct.releaseList[0].expanded;
	if (typeof(ProductInfoStruct.releaseList[0].distributorTopPosition) != 'undefined' && hidedisti == false) disti_to_top = ProductInfoStruct.releaseList[0].distributorTopPosition;
	if (ProductInfoStruct.releaseList[0].blocks.comparisonBlock === true) comparisonEnabled = true;

	// vd
	var methods = {
		init: function(custom_options) {
			$.extend(options, custom_options);
            initialize();
			return this;
		}
	};
	if (methods[method]) {
		return methods[method].apply(this, Array.prototype.slice.call(arguments, 1));
	} else if (typeof method === 'object' || !method) {
		return methods.init.apply(this, arguments);
	} else {
		$.error('Method ' + method + ' does not exist on jQuery.ProductConfigurator');
	}

	function initialize() {
		// This var gets initialized multiple times as a method of empytying the
		// arrays as you loop through the models.
		var gallery_part = {
			'model': '',
			'altText': [],
			'thumbnails': [],
			'medium': [],
			'large': [],
			'types': []
		};

		var found_images = true; // found product level("release") images.
        if (typeof(window.ProductInfoStruct) !== "undefined" && ProductInfoStruct.releaseList[0].modelList.length > 0) {
          

            /************** Build the array of attributes
            *****************************
            */
			for (i = 0; i < ProductInfoStruct.releaseList[0].attributes.length; i++) {
				// This is the array of attributes that gets processed every
				// time we refilter the configurator
				var attribute = {
					"mastername": ProductInfoStruct.releaseList[0].attributes[i].mastername,
					"name": ProductInfoStruct.releaseList[0].attributes[i].name,
					"title": ProductInfoStruct.releaseList[0].attributes[i].title,
					"tooltip": ProductInfoStruct.releaseList[0].attributes[i].tooltip,
					"subitem": ProductInfoStruct.releaseList[0].attributes[i].subitem,
					"filter": null,
					"justclosed": false,
					"filterreason": null,
					"values": []
				};
				// flagging for later processing gallery images differently than
				// when no colors.
				if (attribute.mastername == 'colors-master-parent-feat') withColor = true;
				attributes.push(attribute);
			}

             /**
             ************** END Build the array of attributes
             *****************************
             */
             /**
             ************** Build the default image set for the
            *gallery****************************
            */
			// get the default set of images for the product and populate into
			// the gallery object. Later, when processing models, we do it again
			// with the models array.
			// This is not built with the models, because there is no need for
			// this to be in a loop.
			if (typeof(ProductInfoStruct.releaseList[0].imageSmallPath) !== "undefined" && ProductInfoStruct.releaseList[0].imageSmallPath.length > 0) {
				default_image_src = ProductInfoStruct.releaseList[0].imageSmallPath;
				default_image_alt = ProductInfoStruct.releaseList[0].altText;
				
			}
			/**
             ************** Build the default image set for the
             *gallery****************************
             */
             /**
             ************** Build the array of
             *models****************************
             */
			for (i = 0; i < ProductInfoStruct.releaseList[0].modelList.length; i++) {

				// standard model can be reached through link, and caonfigurator
				// defaults to it, except if overridden by
				// a productSku passed in the url.
				if (ProductInfoStruct.releaseList[0].modelList[i].standardModel) {
					standart_model_id = i;
					standart_model = true;
					standard_model_number = ProductInfoStruct.releaseList[0].modelList[i].modelNumber;
				}
				if (typeof(productSku) != "undefined" && ProductInfoStruct.releaseList[0].modelList[i].modelNumber == productSku) {
					default_sku_id = i;
					default_model = true;
					default_sku_number = ProductInfoStruct.releaseList[0].modelList[i].modelNumber;
				}
				var backorderable = false;
				if (typeof(ProductInfoStruct.releaseList[0].modelList[i].backorderable) !== "undefined") backorderable = ProductInfoStruct.releaseList[0].modelList[i].backorderable;
			
				var model = {
					'number': ProductInfoStruct.releaseList[0].modelList[i].modelNumber,
					'standart': standart_model,
					'backorderable': backorderable,
					'productId': ProductInfoStruct.releaseList[0].modelList[i].drProductId,
					'imageSrc':  "",
					'imageAlt':  "",					
					'attributes': []
				};
				if (typeof(ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath) !== "undefined" && ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath.length > 0) {
						model.imageSrc=ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath;
				}
				if (typeof(ProductInfoStruct.releaseList[0].modelList[i].altText) !== "undefined" && ProductInfoStruct.releaseList[0].modelList[i].altText.length > 0) {
						model.imageAlt=ProductInfoStruct.releaseList[0].modelList[i].altText;
				}
				for (k = 0; k < attributes.length; k++) {
					if (attributes[k].subitem === null) {
						if (typeof(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name]) !== "undefined") {
						    if (attributes[k].values.indexOf(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name]) == -1 && ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name] !== '') {
							//if ($.inArray(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name], attributes[k].values) == -1 && ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name] !== '') {
								attributes[k].values.push(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name]);
							}
							model.attributes.push({
								'id': k,
								'value': ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name]
							});
						}
					} else {
						if (typeof(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name]) !== "undefined" && ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem] !== undefined) {
							 if( attributes[k].values.indexOf(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem]) == -1  && ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem] !== '') {
							//if ($.inArray(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem], attributes[k].values) == -1 && ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem] !== '') {
								attributes[k].values.push(ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem]);
							}
							model.attributes.push({
								'id': k,
								'value': ProductInfoStruct.releaseList[0].modelList[i][attributes[k].name][attributes[k].subitem]
							});
						}
					}
				}

				
                 /**
                 ************** Build the gallery object for all of the
                 * models****************************
                 */
				// except default/release level images which we already built
				// above

				/**
				 * ************* EndBuild the gallery object for all of the
				 * models****************************
				 */
				models.push(model);
			}
			
			// order color attributes.
			if(withColor){
			    var temp_array = [];
			    var colorsCounter = 0;
			    var has_none = false;
			    var none_position = null;
				colorCodes = ProductInfoStruct.releaseList[0].colorsList;  			// fetch the colors order which excludes "None"
			   	for (i = 0; i < attributes.length; i++) {
                    if (attributes[i].mastername == 'colors-master-parent-feat'){
						for(j = 0; j < attributes[i].values.length; j++){
                            if (attributes[i].values[j] == labels.none){      		// check if has none and if so set flag
                            		has_none = true;
                            } else {
                                 temp_array.push(colorCodes[colorsCounter].name);  	// build the temp array from which we'll reorder the color attribute vals.
                                 colorsCounter++; 									// Use a separate counter since we need to skip "None".
                            }  	   
                         } 
                         if (has_none){
							temp_array.push(labels.none);  							// add None to end of array if was found.
                         }
                         for (k = 0; k < attributes[i].values.length; k++){       	// reassign temp array back to attributes[i].
                         	attributes[i].values[k] = temp_array[k];
                         }
                    }
				}    
			}
			
			
			/**
			 * ************* End Build the array of
			 * models****************************
			 */
			/**
			 * ************* Define the default
			 * model****************************
			 */
			if (ProductInfoStruct.releaseList[0].modelList.length > 0) {
				if (default_sku_id != null) {
					default_model_id = default_sku_id;
					default_model_number = default_sku_number;
				} else if (standart_model_id != null) {
					default_model_id = standart_model_id;
					default_model_number = standard_model_number;
				} else if (ProductInfoStruct.releaseList[0].external) {
					default_model_id = ProductInfoStruct.releaseList[0].modelList.length - 1;
					default_model_number = ProductInfoStruct.releaseList[0].modelList[default_model_id].modelNumber;
				} else {
					default_model_id = 0;
					default_model_number = ProductInfoStruct.releaseList[0].modelList[0].modelNumber;
				}
			}
			// reset the vars to default's
			default_sku_id = default_model_id;
			default_sku_number = default_model_number;
			standart_model_id = default_model_id;
			standard_model_number = default_model_number;
			new_selection = default_model_number;
			/**
			 * ************* End Define the default
			 * model****************************
			 */
			if (models.length == 1) ProductInfoStruct.releaseList[0].blocks.attributesBlock = false;
			createHtml();
			if (expanded_configurator && (window.location.hash.length == 0 || window.location.hash == "#features")){
				param_clicked = true; //emulating the behavior of a click thus expanding everything.
      		}
			if (comparisonEnabled) assignButton_CountrySelect();
			$('#configuratorFind').click( function(e) {
	            var theCountry = $('#country').val();
	            getDistributors(theCountry);
            });
			
			
			$('.tooltip-trigger').tooltip();
			equalHeightFilters();
			// This fires off the Gallery on init.
			if (options.gallery != null) {
				// set the default gallery object set
				if (default_model_number == null && standard_model_number == null) {
					default_model_number = "default";
				} else if (default_model_number == null) {
					default_model_number = standard_model_number;
				}
			}
			if (models.length > 0) {
				assignButton_ConfiguratorParam();
			}
			if (default_model_id !== null) {
				for (k = 0; k < models[default_model_id].attributes.length; k++) {
					attributes[models[default_model_id].attributes[k].id].filter = models[default_model_id].attributes[k].value;
				}
			}
			if (models.length > 0) {
				setSelections(default_model_number, "bob");
			}
			var counter = 0;
			// div to be hidden unless valid sku was found
			for (k = 0; k < models.length; k++) {
				if (models[k].number) {
					$('div.infoGoods').show();
					counter++;
				}
			}
			if (counter > 0) {
				refilter();
			}
		} else {
			container.parent('div').hide();
		}
		$(".pdp-buy-toggle-content").on("shown", function () {
			$("#ToggleIcon a").removeClass("collapsed");
		});
		$(".pdp-buy-toggle-content").on("hidden", function () {
			$("#ToggleIcon a").addClass("collapsed");
		});
		
		//because these two vars are static we can hide it once in the init and be done.
		if((attributes.length < 3 || models.length == 1) && !comparisonEnabled){
				$('#ToggleIcon').addClass("hide").removeClass("collpased");
		}
		$("#ToggleIcon a").click(function(event) {
            if($("#ToggleIcon a").hasClass("collapsed")){
                 $("#ToggleIcon a").removeClass("collapsed"); 
            } else {
              $("#ToggleIcon a").addClass("collapsed"); 
            }
       });
      // assignButtonCollapseToggle();
	  if(!comparisonEnabled) paramClickHandler();
	}
	// called by initialize, this function builds the skeleton of the
	// configurator.

	function createHtml() {
		//var html = "<form action=\"http://shop.seagate.com/store\" method=\"GET\" class=\"AddToCartForm\" onSubmit=\"return emptyNull()\">\n";
		//html += "<fieldset>\n";
		// not sure if onlybuy ever turns true.

		var html = "<!-- !SELECT OPTIONS/MODEL -->\n";
		html += "<div class=\"container pdp-buy ds-btm\">\n";
      	html +=    "<div class=\"row-fluid\">\n";
        html += 	"<div class=\"span6 config-options clearfix\">\n";
        if( models.length > 1){
        	html +=        "<div class=\"pdp-buy-title clearfix\">\n";
        	html +=		        "<p class=\"right pdp-buy-modelno modelItems\"></p>\n"; // model no. gets inserted here.
        	html +=             "<h3>" + labels.select_model + "</h3>\n";
        	html +=        "</div>\n";
        	html +=        "<div class=\"pdp-buy-filter\">\n";
        	html += 		  "<div id=\"configuratorContent\">\n";

			for (i = 0; i < attributes.length; i++) {
				if (attributes[i].values.length > 0) {
       				//open non collapsible section
       		    	if( i == 0 ){
       					html += "<ul class=\"pdp-buy-filter-molecule\">\n";
       				}
       				//open collapsible section
       		    	if( i == 2 ){
       					html += "<ul class=\"pdp-buy-toggle-content pdp-buy-filter-molecule collapse \">\n";
       				}
                   	html += "	<li class=\"itemOption\" id=\"itemOption_" + attributes[i].name + "\">\n";
                   	html += "        <h4>" + attributes[i].title ;
                   	if (attributes[i].tooltip != "") {
                        attributes[i].tooltip = attributes[i].tooltip.replace(/\"/g, "&quot;");   
                        html += "        <a href=\"#\" class=\"tooltip-trigger ss-icon\" rel=\"tooltip\" data-original-title=\"" + attributes[i].tooltip + "\">&#x2753;</a>\n";
			    	}
                   	html += "        </h4>\n";
                   	html += "        <ul class=\"pdp-buy-filter-atom\">\n";
                   
                   
                   for (k = 0; k < attributes[i].values.length; k++) {
						if (attributes[i].values[k] == labels.none) {
							var buf = attributes[i].values[k];
							attributes[i].values.splice(k, 1);
							attributes[i].values.push(buf);
							break;
						}
					}
					for (k = 0; k < attributes[i].values.length; k++) {
						html += "<li class=\"disabled\"><a class=\"configurator_param\"  href=\"#\" rel=\"" + i + "\" val=\"" + attributes[i].values[k].replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '') + "\">" + attributes[i].values[k] + "</a></li>\n";
					}
                   

                   	html += "        </ul>\n";
                   	html += "    </li>\n";
                   	//close non collapsible section
                    if( i == 1){
       					html += "</ul>\n";
       				}
       				//close collapsible section
       				if( i == attributes.length-1){
       					html += "</ul>\n";
       				}
				}
			}
            html += "	<ul class=\"pdp-buy-legend\">";
            html += " 		<li class=\"pdp-buy-selected\"><span></span>" + labels.selected + "</li>";
            html += " 		<li class=\"pdp-buy-available\"><span></span>" + labels.available + "</li>";
            html += "		<li class=\"pdp-buy-unavailable\"><span></span>" + labels.unavailable + "</li>";
            html += "	</ul>";
        	html += "           </div>\n"; // end configuratorContent 
        	html += "       </div>\n";
			html += "		<div class=\"pdp-buy-image\">\n";
        	html += "        	<img src=\"" + default_image_src + "\" alt=\"" + default_image_alt + "\" >\n"; //default image goes here.
        	html += "        </div>\n";
        }  // end if not a single model
        html += "    </div><!-- end configurator  span6 section --> \n"; 

        
	    if(stx_store){
	    	html += "   <div class=\" buySeagateContent span3\">\n";
			html += '     	<div class="pdp-buy-title">\n';
            html += '             <h3>' + labels.buy_from_seagate + '</h3>\n';
			html += ' 		</div>\n';
	    	html += "   <div class=\"store-response\">\n";
        	html += "    </div>\n";
        	html += "   </div>\n";
        } 
        html += "    <div class=\"span3\">\n"; //Begin partner and disti section

		var countryCodeStr = $("#countryCodes").val();
		var countryCode = countryCodeStr.split('|');
		var countryStr = $("#countryNames").val();
		var countryName = countryStr.split('|');
		var distiHtml = "";
		var resellersHtml = "";

			if (hidedisti === false) {
			    var country_default = $("#countryDefault").val();
			    if(country_default == "EM") country_default = "AE";
			    
			    if(disti_to_top || !stx_store || !comparisonEnabled){ // if resellers is on the bottom and needs to be collapsible
					distiHtml += "<div class=\"pdp-buy-distributor findDistributor\" >\n";
			    }else{
			        distiHtml += "<div class=\"pdp-buy-distributor findDistributor pdp-buy-toggle-content collapse \" >\n";
			    }
    			distiHtml += "               <div class=\"pdp-buy-title\">\n";
                distiHtml += "                   <h3>" + labels.find_a_distributor + "</h3>\n";
                distiHtml += "               </div>\n";
            	distiHtml += "            	<div class=\"buy-box clearfix\">\n";
            	distiHtml += "                    <ul class=\"unstyled buy-box-table\">\n";
            	distiHtml += "                        <li>\n";
	        	distiHtml += "                            <select id=\"country\" name=\"country\" title=\"country\" tabindex=\"1\">\n";
				for (var u = 0; u < countryName.length; u++) {
					if (country_default == countryCode[u]) {
						distiHtml += "<option value=" + countryCode[u] + " selected=\"selected\">" + countryName[u] + "</option>\n";
					} else {
						distiHtml += "<option value=" + countryCode[u] + ">" + countryName[u] + "</option>\n";
					}
    			}
            	distiHtml += "                            </select>\n";
            	distiHtml += "                        </li>\n";	
            	distiHtml += "                        <li><a href=\"#distiModal\" data-toggle=\"modal\" class=\"distributorsList button button-teal button-xs pull-right\" id=\"configuratorFind\">" + labels.find + "</a></li>\n";
            	distiHtml += "                    </ul>\n";
            	distiHtml += "					 <input type=\"hidden\" value=\"US\" name=\"country\" id=\"country\">\n";
            	distiHtml += "                </div>\n";  // close .buy-box
        		distiHtml += "            </div>\n";   // close   .pdp-buy-distributor

			}
			if (comparisonEnabled) {
			    if(disti_to_top && stx_store){ // if resellers is on the bottom and needs to be collapsible
					resellersHtml += "<div class=\"pdp-resellers pdp-buy-toggle-content collapse\" >\n";
			    }else{
			        resellersHtml += "<div class=\"pdp-resellers\" >\n";
			    }
				resellersHtml += "<div class=\"pdp-buy-title resellersTitle\">\n";
                resellersHtml += "<h3>" + labels.buy_from_reseller + "</h3>\n";
				resellersHtml += "</div>\n";
        		resellersHtml += "<div class=\"rsPadRoundBox resellersPulldown \">\n";
				resellersHtml += "<div class=\"findDistributorForm buy-box clearfix\">\n";
				resellersHtml += "<ul class=\"unstyled buy-box-table\">\n";
				resellersHtml += "<li>\n";
				resellersHtml += "<select id=\"ResellerCountry\" name=\"ResellerCountry\" title=\"ResellerCountry\" tabindex=\"1\">\n";
				for (var u = 0; u < countryName.length; u++) {
					if (UserCountryCode == countryCode[u]) {
						resellersHtml += "<option value=" + countryCode[u] + " selected=\"selected\" >" + countryName[u] + "</option>\n";
					} else {
						resellersHtml += "<option value=" + countryCode[u] + ">" + countryName[u] + "</option>\n";
					}
				}
				resellersHtml += "</select>\n";
				resellersHtml += "</li>\n";
				resellersHtml += "</ul>\n";
				resellersHtml += "</div>\n";//end findDistributorForm div
				resellersHtml += "</div>\n";  

				resellersHtml += "<div class=\"resellersContent pdp-buy-resellers\">\n";
					//		resellesrs go here
            	resellersHtml += "</div>\n"; // End resellersContent.
            	resellersHtml += "</div>\n"; // End pdp-resellers.
			}
		if(stx_store){
			if(disti_to_top){
				html += distiHtml;
				html += resellersHtml;
			} else {
				html += resellersHtml;
				html += distiHtml;
			}//end else of "if disti to top"
		} else {			
				html += resellersHtml;
			if(comparisonEnabled){
				html += "</div><div class=\"span3\">"; // separate to two columns if no buy from seagate.
				html += distiHtml;
			} else { // move disti to middle column if no resellers.
				html += distiHtml;
				html += "</div><div class=\"span3\">";
			}
		}
	    html += "            </div>\n"; // close .span3
		html += "</div>\n";// end disti section? close .row-fluid
		html += "     <div class=\"pdp-buy-toggle\">\n";
		html += "         <div id=\"ToggleIcon\">\n";
		if (expanded_configurator && (window.location.hash.length == 0 || window.location.hash == "#features")){
        	html += "    	<a class=\"pdp-buy-toggle-icon ss-icon\" data-toggle=\"collapse\" data-target=\".pdp-buy-toggle-content\"><span>&#x25BE;</span><strong>&#x25B4;</strong></a>\n";
        }else{
        	html += "    	<a class=\"pdp-buy-toggle-icon ss-icon collapsed\" data-toggle=\"collapse\" data-target=\".pdp-buy-toggle-content\"><span>&#x25BE;</span><strong>&#x25B4;</strong></a>\n";
        }
        html += "    	</div>\n";  // close 	ToggleIcon
        html += "    </div>\n";  // close 	.container
		html += "</div>\n"; // close .row-fluid
		//html += "</fieldset>\n";
		//html += "</form>\n";
		container.html(html);
	////	if(RGID.length < 4){
	////		getResellers(selectedCountryCode);
	////	}
		if(!stx_store && hidedisti && !comparisonEnabled){
		    if(rclocale == "ar-em"){
				$('.pdp-buy .row-fluid').css('background', 'url("data:image/gif;base64,R0lGODlhAgABAIAAAN3d3QAAACH5BAAAAAAALAAAAAACAAEAAAICBAoAOw==") repeat-y scroll 51% top');
			}else{
				$('.pdp-buy .row-fluid').css('background', 'url("data:image/gif;base64,R0lGODlhAgABAIAAAN3d3QAAACH5BAAAAAAALAAAAAACAAEAAAICBAoAOw==") repeat-y scroll 49% top');
			}
		}
		if(models.length == 1){
			var single_model_content = $('#SingleModelContent').html();
			var model_number_html = "";
			var default_image_html = "";

			model_number_html +=        "<div class=\"pdp-buy-title clearfix\">\n";
        	model_number_html +=		        "<p class=\"right pdp-buy-modelno\"><span>" + ProductInfoStruct.releaseList[0].modelList[0].modelNumber + "</span></p>\n"; // model no. gets inserted here.
        	//model_number_html +=             "<h3>" + labels.select_model + "</h3>\n";
        	model_number_html +=             "<h3>In the box</h3>\n";
        	model_number_html +=        "</div>\n";


        	
			default_image_html += "		<div class=\"pdp-buy-image\">\n";
        	default_image_html += "        	<img src=\"" + default_image_src + "\" alt=\"" + default_image_alt + "\" >\n"; //default image goes here.
        	default_image_html += "        </div>\n";
			$('.config-options').html(single_model_content);
			//$('.config-options').prepend(model_number_html);
			$('.config-options').append(default_image_html);

		}
	}

	function assignButton_ConfiguratorParam() {
		container.find('.configurator_param').click(function(event) {
			event.preventDefault();
			// suppressing the click on selected params for expanding the configurator.
			if (!$(this).parent('li').hasClass("selected")) {
				var id = $(this).attr('rel');
				var value = $(this).attr('val');
				getColorModel(value);
				attributes[id].filter = value;
				param_clicked = true;
			    setSelections(id.toString(), value.toString());
				equalHeightFilters();
				refilter();
				$('.pdp-buy-toggle-content').collapse('show');		
			     $('.pdp-buy-toggle a').removeClass('collapsed');
			     $('.pdp-buy-toggle-content.collapse.pdp-buy-resellers').addClass('in');
			} else {
				 $('.pdp-buy-toggle-content').collapse('show');		
			     $('.pdp-buy-toggle a').removeClass('collapsed');
			     $('.pdp-buy-toggle-content.collapse.pdp-buy-resellers').addClass('in');
			     equalHeightFilters();
			}
		});
	}
	
	function assignButton_CountrySelect() {
		container.find('#ResellerCountry').change(function(event) {
			event.preventDefault();
			param_clicked = true;
			// suppressing the click on selected params for expanding the configurator.
			getResellersByType($('#ResellerCountry option:Selected').val());
		});
	}
	
	function setSelections(id, val) {
		// we assume there will never be more than 10 attributes.
		single_model = true;
		var modelHtml = "";
		var modelAlert = null;
		var clear_selections = false;
		var selected = [];
		var unique = null;
		var bob = [];
		var default_selections = [];
		selections.length = 0;
		
		if (selected_model_id == null) {
			selected_model_id = default_model_id;
		}
		if (id.length == 1) {
			if ($('.configurator_param[rel=' + id + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').hasClass('disabled')) {
				$('.configurator_param[rel=' + id + ']').parent().removeClass('selected');
				$('.configurator_param[rel=' + id + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').removeClass('disabled');
				$('.configurator_param[rel=' + id + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').addClass('selected');
				if (!getSelectedModelNumber(id)) {
				   
					////modelHtml = "<p class=\"rsPadRoundBox modelNumber\">\n";
					////modelHtml += "<span class=\"title\">" + labels.model_number + ":</span>\n";
					////modelHtml += "<span class=\"modelNotSelected\">" + labels.not_selected + "</span>\n";
					////modelHtml += "</p>\n";
					////modelHtml += "<p class=\"rsPadRoundBox modelAlertMessage\">" + labels.select_value + "</p>\n";
					$('.modelItems').html(modelHtml);
					$('.store-response').empty();
					$('.config-options').css('display', 'block');
					
					if(RGID.length == 4){		//if a valid CI domain
						$('.resellersContent').empty();
					}
					$('.moreResellersBtn').remove();
					clear_selections = true;
				} else {
					id = getSelectedModelNumber(id);
					selected_model_id = getSelectedModelId(id);
					single_model = true;
					modelList.length = 0;
					for (i = 0; i < attributes.length; i++) {
						$('.configurator_param[rel=' + i + ']').parent('li').removeClass('selected');
						$('.configurator_param[rel=' + i + ']').parent('li').addClass('disabled');
						if (i != id) {
							attributes[i].filter = null;
						}
					}
					setSelections(id, "bob");
					return; // prevent continuing from here when done.
				}
			}
		}
		// Remove all selections, enable/select current selection and run again.
		if (clear_selections) {
			for (i = 0; i < attributes.length; i++) {
				$('.configurator_param[rel=' + i + ']').parent('li').removeClass('selected');
				$('.configurator_param[rel=' + i + ']').parent('li').addClass('disabled');
				if (i != id) {
					attributes[i].filter = null;
				}
			}
			// re-enable current choice.
			$('.configurator_param[rel=' + id + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').removeClass('disabled')
			modelList.length = 0;
			// since we started a new selection round, all model are possible
			// matches so resetting the eligible models to the full set.
			for (k = 0; k < models.length; k++) {
				modelList.push(models[k]);
			}
			// run again with the new selection and complete set of models
			setSelections(id, val);
		}
		// if id.length is greater than 1 that means we passed the model number
		// as the id and this gets processed differently
		if (id.length > 1) {
			// it's a single model so it's the only one that will match.
			modelList.push(models[selected_model_id]);
		} else {
			// if id ==1 than an attribute got clicked and we need to reset the
			// array of matching models. building temp array - bob.
			for (k = 0; k < modelList.length; k++) {
				var attribute_value = modelList[k].attributes[id].value;
				// we have issues with jquery selector unable to handle special
				// characters, so replacing.
				attribute_value = attribute_value.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '');
				if (attribute_value == val) {
					bob.push(modelList[k]);
				}
			}
		}
		// resetting the matched models array by clearing it and transferring
		// bob to it.
		if (modelList.length > 1) {
			modelList.length = 0;
			for (k = 0; k < bob.length; k++) {
				modelList.push(bob[k]);
			}
		}
		// buid an array of the attribute values that are still available based
		// on the remaining models list.
		if (models.length > 0) {
			for (i = 0; i < attributes.length; i++) {
				selections[i] = [];
				for (k = 0; k < modelList.length; k++) {
					selections[i][k] = modelList[k].attributes[i].value;
					selections[i][k] = selections[i][k].replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '');
				}
			}
		}
		// process the selections and disbale, whiten, or select as needed.
		for (j = 0; j < attributes.length; j++) {
			var availableCount = 0;
			// If the attribute is the one that was just clicked greyout the
			// whole row and then whiten and select what was just clicked.
			if (j == id) {
				$('.configurator_param[rel=' + j + ']').parent('li').removeClass('selected');
				$('.configurator_param[rel=' + j + ']').parent('li').addClass('disabled');
				$('.configurator_param[rel=' + j + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').removeClass('disabled');
				$('.configurator_param[rel=' + j + ']').filter($('.configurator_param[val="' + val + '"]')).parent('li').addClass('selected');
			} else {
				// grey out the row by adding the disabled class.
				var attributeContainer = $('.configurator_param[rel=' + j + ']').parent('li');
				attributeContainer.addClass('disabled');
				// iterate through all anchor elements in attribute row
				$('.configurator_param[rel=' + j + ']').each(function(index) {
					// re-enable any selection that matches the remaining models.
					for (l = 0; l < selections[j].length; l++) {
						//if ($.inArray(selections[j], $(this).attr('val'))) {
						if (selections[j].indexOf($(this).attr('val')) >-1 ) {
							// console.log("Remove disabled
							// from:"+$(this).attr('val'));
							$('.configurator_param[rel=' + j + ']').filter($('.configurator_param[val="' + selections[j][l] + '"]')).parent('li').removeClass('disabled');
						}
					}
					if ($(this).parent('li').hasClass('disabled') == false) {
						availableCount++;
					}
				});
				// If only one option is left, add the "selected" class to it.
				if (availableCount == 1) {
					$('.configurator_param[rel=' + j + ']').each(function(index) {
						if ($(this).parent('li').hasClass('disabled') == false) {
							$(this).parent('li').addClass('selected');
							attributes[j].filter = $(this).attr('val').replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '');
						}
					});
				}
			}
		}
		// set the classes to display the attributes for a single model.
		if (id.length > 1) {
			for (k = 0; k < attributes.length; k++) {
				default_selections[k] = models[selected_model_id].attributes[k].value;
				default_selections[k] = default_selections[k].replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '');
				$('.configurator_param[rel=' + k + ']').filter($('.configurator_param[val="' + default_selections[k] + '"]')).parent('li').addClass('selected');
			}
		}
		// if we still have an unselected attribute, the value of single_model
		// will switch to false
		for (k = 0; k < attributes.length; k++) {
			single_model = $('.configurator_param[rel=' + k + ']').parent('li').hasClass('selected');
			if (single_model == false) {
				break;
			}
		}
		// if single model is true, get it, build the html for the models block,
		// and refilter with allChoosed.
		if (single_model || id.length > 1) {
		    ////$('.modelItems').show();
			new_selection = getSelectedModelNumber(selected_model_id);
			allChoosed = true;
			for (k = 0; k < models.length; k++) {
				if (models[k].number == selected_model) {
					single_model_id = k;
					break; 
				}
			}
			if (comparisonEnabled && (prev_model_number == null || prev_model_number.indexOf(new_selection) == -1)) {
				prev_model_number = new_selection;
				getResellersByType(selectedCountryCode);
		////	if(RGID.length == 4){ //if a valid CI locale
	////			getChannelIntelligence(new_selection);
	////		}
				if(stx_store){
					var selectedPID = models[getSelectedModelId(new_selection)].productId;
					getDigitalRiver(selectedPID, POP);
				}
			} else if (stx_store && (prev_model_number == null || prev_model_number.indexOf(new_selection) == -1)){ // handle stx_store with comparsion hidden.
				prev_model_number = new_selection;	
				var selectedPID = models[getSelectedModelId(new_selection)].productId;
				getDigitalRiver(selectedPID, POP);
			} else {
				prev_model_number = "none";
			}
		} else {
		   // $('.').hide();
			allChoosed = false;
			prev_model_number = "none";
			if(stx_store){
				buildEmptyBuySection();
			}
		}
	}

	function getSelectedModelNumber(id) {
		var current_selections = [];
		selected_model = null;
		var selected_models = [];
		var modelHtml = "";;
		// id can be an attribute or a model number.
		if (models.length == 1){
			selected_model = models[0].number;
			modelHtml += " <span id=\"modelItem_" + selected_model + "\">" + selected_model + "</span>\n";
			////modelHtml += "</p>\n";
			$('.modelItems').html(modelHtml);
		}
		if (id.length > 1) {
			selected_model = id;
			////modelHtml = "<p class=\"rsPadRoundBox modelNumber\">\n";
			////modelHtml += "<span class=\"title\">" + labels.model_number + ":</span>\n";
			modelHtml += " <span id=\"modelItem_" + selected_model + "\">" + selected_model + "</span>\n";
			////modelHtml += "</p>\n";
			$('.modelItems').html(modelHtml);
		} else {
			for (i = 0; i < attributes.length; i++) {
				$('.configurator_param[rel=' + i + ']').each(function(index) {
					if ($(this).parent('li').hasClass('selected')) {
						current_selections.push($(this).text());
						// all_selected++;
						// alert(current_selections[i]);
					}
				});
			}
			// if all we have passed in is the attribute id, then we loop
			// through the models and figure which model matches our selections.
			if (current_selections.length == attributes.length) {
				for (k = 0; k < models.length; k++) {
					var complete_match = 0;
					for (i = 0; i < attributes.length; i++) {
						if (current_selections[i] == models[k].attributes[i].value) {
							complete_match++;
						}
					}
					// if we found the matching model build the models block
					// with it.
					if (complete_match == attributes.length) {
						selected_model = models[k].number;
						////modelHtml = "<p class=\"rsPadRoundBox modelNumber\">\n";
						////modelHtml += "<span class=\"title\">" + labels.model_number + ":</span>\n";
						modelHtml += " <span id=\"modelItem_" + selected_model + "\">" + selected_model + "</span>\n";
						////modelHtml += "</p>\n";
						$('.modelItems').html(modelHtml);
						break;
					}
				}
			}
		}
		// alert(selected_model);
		return selected_model;
	}

	function getSelectedModelId(selected_model_number) {
		for (k = 0; k < models.length; k++) {
			if (models[k].number == selected_model_number) {
				selected_model_id = k;
			}
		}
		return selected_model_id;
	}

	function getColorModel(color) {
		var color_model = null;
		for (i = 0; i < ProductInfoStruct.releaseList[0].modelList.length; i++) {
			if (typeof(ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat) != 'undefined' && typeof(ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat.colors_master_parent_feat_name) != 'undefined') {
				if (ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat.colors_master_parent_feat_name == color) {
					color_model = ProductInfoStruct.releaseList[0].modelList[i].modelNumber;
					gallery_model_id = i;
				}
			}
		}
		if (gallery_model_id != null && typeof(ProductInfoStruct.releaseList[0].modelList[gallery_model_id].imageSmallPath) !== "undefined" && ProductInfoStruct.releaseList[0].modelList[gallery_model_id].imageSmallPath.length == 0) {
			color_model = "default";
			gallery_model_id = 0;
		}
		return color_model;
	}
	
	function changeModelPicture(pic_model){
	    if (pic_model == "default") pic_model = "0";
		var pic_model_id = getSelectedModelId (pic_model);
		product_image_src = models[pic_model_id].imageSrc;
		product_image_alt = models[pic_model_id].imageAlt;
		if(product_image_src == ""){
			product_image_src = default_image_src;
			product_image_alt = default_image_alt;
		}
	
		$('div.pdp-buy-image img').attr({
		    src: product_image_src,
     		alt: product_image_alt
		});
	
	}

	function confirmDecimals(price) {
		if(/\d/.test(price)){
			if (price.indexOf('.') == -1) {
				price = price + ".00";
			} else if (price.length - price.indexOf('.') == 2) {
				price = price + "0";
			}
		}
		return price;
	}
	
	
	function getDigitalRiver(PID, POP){
	
   /*var store_product_info = {
   "storeProduct":[
      {
         "pid":"281182500",
         "price":"99.00",
         "discountedPrice":"89.00",
         "stockStatus":"In Stock",
         "offersList":[
            {
               "offerName":"This is the first offer name",
               "offerPitch":"This is the first offer pitch"
            },
            {
               "offerName":"This is the second offer name",
               "offerPitch":"This is the second offer pitch"
            }
         ]
      }
   ]};*/
		var store_response = "";
		var backorderable = false;
	    var preoderable = "";
		var stock_status = "";
		var stock_message = "";
		var price = "";
		var discounted_price = "";
    	var offers_list = [];
        if(PID == ""){
			$('.store-response').empty();
			$('.config-options').css('display', 'block');
			store_response += '<p class="rsPadRoundBox modelAlertMessage">' + labels.not_available_seagate + '</p>';	
			$('.store-response').append( store_response );	
        } else {
			$.ajax({
				beforeSend: function() {
					$('.store-response').empty();
					store_response  += "<p class=\"rsPadRoundBox modelAlertMessage modelLoadingMessage\">" + labels.wait_message + "</p>"; 
               	 	$('.store-response ').html(store_response);     
                	store_response  = "";
					$('.config-options').css('display', 'block');

				},
				//http://wwwdevedit.seagate.com/ww/jsp/common/dr.jsp?drProductId=303626100&popName=value-add&drLocale=en_CA&currency=CAD
				//url: 'http://wwwdevedit.okla.seagate.com/ww/jsp/common/dr.jsp?drProductId=281182500&popName=value-add',
				url: '/ww/jsp/common/dr.jsp?drProductId=' + PID + '&popName=' + POP +'&drLocale=' + dr_locale + '&currency=' + ecomm_currency,
				success: function(data) {  
				
					$('.store-response').empty();
					$('.config-options').css('display', 'block');
					
					for (i = 0; i < models.length; i++) {
						if (models[i].productId == PID) {
							backorderable = models[i].backorderable;
							break;
						}
					}

				    var store_product_info = data;
				    if(typeof(store_product_info.storeProduct) == "undefined" || typeof(store_product_info.storeProduct[0]) == "undefined" || store_product_info.storeProduct[0].pid == ""){
				    	$('.store-response').empty();
				    	$('.config-options').css('display', 'block');
						store_response += '<p class="rsPadRoundBox modelAlertMessage">' + labels.not_available_seagate + '</p>';	
						$('.store-response').append( store_response );
					} else { // if models are returned.
 	 	 				stock_status = store_product_info.storeProduct[0].stockStatus;
 	 	 				preoderable	 = store_product_info.storeProduct[0].preorderEnabled;
 	 	 				price = store_product_info.storeProduct[0].price;
 	 	 				discounted_price = store_product_info.storeProduct[0].discountedPrice;

                		for (i = 0; i < store_product_info.storeProduct[0].offersList.length; i++) {

								// This is the array of attributes that gets processed every
								// time we refilter the configurator
							var offer = {
								"offer_name": store_product_info.storeProduct[0].offersList[i].offerName,
								"offer_pitch": store_product_info.storeProduct[0].offersList[i].offerPitch				
							};

							offers_list.push(offer);
                		}
						if (stock_status == "PRODUCT_INVENTORY_IN_STOCK" &&  preoderable == "true") stock_message = labels.preorder;           
      	   				else if (stock_status == "PRODUCT_INVENTORY_IN_STOCK") stock_message = labels.instock;
      	   				else if (backorderable && (stock_status == "PRODUCT_INVENTORY_OUT_OF_STOCK" || stock_status == "PRODUCT_INVENTORY_BACKORDERED")) stock_message = labels.backorder;
						else if (stock_status == "PRODUCT_INVENTORY_OUT_OF_STOCK" || stock_status == "PRODUCT_INVENTORY_BACKORDERED") stock_message = labels.outofstock;
						
						

						

						store_response += '     <div class="pdp-buy-seagate">\n';
               			store_response += '        <div class="buy-box clearfix">\n';
               			store_response += '         	<ul class="unstyled buy-box-table">\n';
               			store_response += '             	<li>\n';
               			
               			if (discounted_price == "" || discounted_price == price ){    
               				store_response += ' 				<strong>' + price + '</strong>\n';  
               			} else {
               				store_response += '					<em class="pdp-buy-old-price">' + price + '</em>\n';  
               			    store_response += ' 				<strong class="pdp-buy-new-price">' + discounted_price + '</strong>\n';  
               			}
               			store_response += '             	</li>\n';
               			
               			if (stock_message == labels.outofstock){
               				store_response += '                 <li><span class="button button-orange button-xs pull-right button-disabled" href="#">' + labels.add_to_cart + '</span></li></ul>\n';    
               				store_response += '					<small class="stock-status-outofstock">'  + stock_message +  '</small>\n';
               			} else {
               				store_response += '					<li><a class="button button-orange button-xs pull-right" href="http://shop.seagate.com/store/sgateus/' + dr_locale + '/buy/productID.' + PID + '/quantity.1/Currency.' + ecomm_currency+ '">' + labels.add_to_cart + '</a></li></ul>\n';  
               				store_response += '					<small class="stock-status">'  + stock_message +  '</small>\n';
               			}
               	
               			if(offers_list.length > 0){
                        	store_response += '    <div class="buy-box-offer">\n';
                        	for (i = 0; i < offers_list.length; i++){
                                store_response += '        <h4>' + offers_list[i].offer_name + '</h4>\n';
                                if(offers_list[i].offer_pitch != ""){
                                     store_response += offers_list[i].offer_pitch;
                                }
                            }
                        	store_response += '    </div>\n';
                         } 
                        
                         store_response += '  </div>\n';


						 $('.store-response').append( store_response );
					}
				},
				error: function(){
				    $('.store-response').empty();
				    $('.config-options').css('display', 'block');
					store_response += '<p class="rsPadRoundBox modelAlertMessage">' + labels.not_available_seagate + '</p>';	
					$('.store-response').append( store_response );	
				}
			});  //end ajax
  		} // end else	
	}

	function getChannelIntelligence(selectedModelNumber) {
	
		var no_price_locales = ["DE", "FR", "AU", "CN", "SG", "IN"];
		var vendors = [];
		var seagate_id = null;
		var resellersContent = "";
		var found_seagate = 0;
		var counter = 0;
		
		$.ajax({
			beforeSend: function(jqXHR, settings) {
				// Setup "loading" message
				$('.resellersContent').empty();
				$('.moreResellersBtn').remove();
				resellersContent += "<p class=\"rsPadRoundBox modelAlertMessage modelLoadingMessage\">" + labels.wait_message + "</p>";
				
                $('.resellersContent').html( resellersContent );
                resellersContent = "";
			},
			url: '/ww/jsp/common/ajax.jsp?sku=' + selectedModelNumber + '&rgid=' + RGID + '&sct=' + CI_LinkID,
			success: function(data) {
			    
				$('.modelAlert').empty();
				////$('.buySeagateContent').empty();
				$('.resellersContent').empty();
				$('.moreResellersBtn').remove();
			
				$(data).find('DEALER_ITEM').each(function(index) {
					var vendor = {
						'id': $(this).find('DEALER_ID').text(),
						'availability': $(this).find('AVAILABILITY').text(),
						'price': $(this).find('PRICE').text(),
						'buy_url': $(this).find('BUY_URL').text(),
						'logo': ''
					}
					vendors.push(vendor);
				});

                resellersContent += "<div class=\"pdp-buy-resellers\">\n";
                
                

				if (typeof(vendors[0]) != 'undefined') {
				
					var max_vendors = vendors.length;
					if (max_vendors > 4) max_vendors = 4;


					for (i = 0; i < max_vendors; i++) {
						if (vendors[i].id.indexOf('285659589') == -1) {
						    found_seagate = 1;
						    counter++;
							vendors[i].name = $(data).find('DEALER[id="' + vendors[i].id + '"]').find('DEALER_NAME').text();
							vendors[i].logo = $(data).find('DEALER[id="' + vendors[i].id + '"]').find('DEALER_LOGO').text();
							if(counter == 3){
								resellersContent += "    </div><div class=\"pdp-buy-toggle-content collapse pdp-buy-resellers \">\n";
							}

							resellersContent += "    <div class=\"buy-box clearfix\">\n";

              			  	resellersContent += "        <ul class=\"unstyled buy-box-table\">\n";
							resellersContent += "             <li><img width=\"60\" height=\"40\" src=\"" + vendors[i].logo + "\" alt=\"" + vendors[i].name + "\"/><span class=\"rsPrice\" style=\"margin-left: 8px;\"><strong>" + confirmDecimals(vendors[i].price) + "</strong></span></li><li><a class=\"button button-teal button-xs pull-right\" target=\"_blank\" href=\"" + vendors[i].buy_url + "\">" + labels.buy_now + "</a></li>";
							resellersContent += "        </ul>\n";
                			resellersContent += "		</div>\n";
						
					  } 
					    else if (vendors.length > max_vendors) {
							max_vendors++;
				      }
					}
					showHideToggle(vendors.length - found_seagate);
					if(vendors.length == 1 && vendors[0].id.indexOf('285659589') != -1 ){ // if there is only one reseller and it is seagate we hide in new pdp
						if(wtb_resellers_data.length == 0 || wtb_data_country_code != selectedCountryCode){ 
							 buildResellersDataVar(selectedCountryCode);
						}
						if (wtb_resellers_data.length > 5){ // if it's more than the "none" we assigned when no retailers were returned.
							resellersContent += wtb_resellers_data;
							showHideToggle(resellers_var_vendors);
							paramClickHandler();
						} else { // in no CI nor WTB resellers
						//	$('.resellersTitle').remove();
							$('.resellersContent').empty();
							paramClickHandler();
							return;
						}
					}

				} else {//if no vendors
					if(wtb_resellers_data.length == 0 || wtb_data_country_code != selectedCountryCode){ 
						buildResellersDataVar(selectedCountryCode);
					}
					if (wtb_resellers_data.length > 5){
						resellersContent += wtb_resellers_data;
					} else {
				//		$('.resellersTitle').remove();
						$('.resellersContent').empty();
						showHideToggle(0);
						paramClickHandler();
						return;
					}
					showHideToggle(resellers_var_vendors);			
				}

                 resellersContent += "		<div class=\"resellers-link clearfix\">\n";
				//resellers link gets inserted here					
                 resellersContent += "		</div>\n";
                 resellersContent += "</div>\n";
                resellersContent += "</div>\n";

                $('.resellersContent').html( resellersContent );
                if (typeof(vendors[i]) != 'undefined' && vendors.length > 4) {
				           createResellersLink(new_selection);
				}
				for(j = 0; j < no_price_locales.length; j++){
						if (no_price_locales[j] == selectedCountryCode) {
							$('.rsPrice').html('&nbsp;');
							break;
						}
				}
			    paramClickHandler(); 
			}
			
		});
	}
	
	function buildResellersDataVar(country_code) {
        var counter = 0;
		var vendors = [];
		if(country_code != wtb_data_country_code){

			$.ajax({
			    async : false,
				beforeSend: function(jqXHR, settings) {
					;
				},
				url: '/ww/jsp/common/ajax.jsp?country=' + country_code + '&sfdc=1',
				success: function(data) {  
					if($(data).find('DEALER').length > 0){
						$(data).find('DEALER').each(function(index) {
							var vendor = {
								'logo':  $(this).find('DEALER_LOGO').text(),
								'name': $(this).find('DEALER_NAME').text(),
								'buy_url': $(this).find('BUY_URL').text()
							}
							vendors.push(vendor);
						});
					    wtb_vendors = vendors.length; // if less than three, perhaps we won't need expander toggle icon.
						resellers_var_vendors = wtb_vendors // need it stored for later when called in getChannelIntelligence
						if (typeof(vendors[0]) != 'undefined' ) {	
							wtb_resellers_data ="";		
							for (i = 0; i < vendors.length; i++) {
								if(counter == 2){
										wtb_resellers_data += "    </div><div class=\"pdp-buy-toggle-content collapse  pdp-buy-resellers\">\n";
								}
								counter++;
								wtb_resellers_data += "    <div class=\"buy-box clearfix\">\n";

     	         			  	wtb_resellers_data += "        <ul class=\"unstyled buy-box-table\">\n";
								wtb_resellers_data += "             <li><img height=\"40\" src=\"" + vendors[i].logo + "\" alt=\"" + vendors[i].name + "\"/></li><li><a class=\"button button-teal button-xs pull-right\" target=\"_blank\" href=\"" + vendors[i].buy_url + "\">" + labels.shop + "</a></li>";
								wtb_resellers_data += "        </ul>\n";
     	           				wtb_resellers_data += "	</div>\n";	
     	           			
							}
							 wtb_resellers_data += "	</div>\n"; // .pdp-buy-resellers
						}
	
					} else {
	 	                wtb_resellers_data = "none";
					}
				},
				error: function(){
					 wtb_resellers_data = "none";
		    	}
		  });
		  wtb_data_country_code = country_code;
		}
	}
	
	function buildEmptyBuySection(){
	
		var resellersContent = "";
	    var buySeagateContent = "";
	    var modelHtml = labels.model_not_selected;
	    $('.modelItems').html(modelHtml);
	            	  
	    if(stx_store){  	  
	            $('.store-response').empty();  	    	

				buySeagateContent += "<p>" + labels.select_option_value + "</p>";

				$('.store-response').append( buySeagateContent );
		}	
		$('.resellersContent').empty();
	//	resellersContent += "<div class=\"pdp-buy-title resellersTitle\">\n";
   //     resellersContent += "   <h3>" + labels.buy_from_reseller + "</h3>\n";
	//	resellersContent += "</div>\n";
        resellersContent += "<div class=\"pdp-buy-resellers\">\n";
		resellersContent += "<p>" + labels.select_option_value + "</p>";
        resellersContent += "</div>\n";
        $('.resellersContent').append( resellersContent );
        paramClickHandler();
        showHideToggle(0);
	}

	function getColorPic(color) {
		var color_pic = null;
		for (i = 0; i < ProductInfoStruct.releaseList[0].modelList.length; i++) {
			if (typeof(ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat) != 'undefined' && typeof(ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat.colors_master_parent_feat_name) != 'undefined') {
				if (ProductInfoStruct.releaseList[0].modelList[i].colors_master_parent_feat.colors_master_parent_feat_name == color) {
					color_model = ProductInfoStruct.releaseList[0].modelList[i].modelNumber;
					if (typeof(ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath) != 'undefined' && ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath != '') {
						color_pic = ProductInfoStruct.releaseList[0].modelList[i].imageSmallPath;
						break;
					} else {
						color_pic = ProductInfoStruct.releaseList[0].imageSmallPath;
					}
				}
			}
		}
		return color_pic;
	}


	// Rebuilds the configurator with current selection. This function also
	// fires on initial load.

	function refilter() {
		var uniqueColor = null;
		for (i = 0; i < attributes.length; i++) {
			// alert(attributes[i].values.length + " jjj " +
			// attributes[i].values[0]);
			if (attributes[i].values.length == 1) {
				// alert(attributes[i].values + " jjj");
				attributes[i].filter = attributes[i].values[0];
			}
		}
		if (attributes.length === 0) {
			$('.infoGoods').hide();
	    } else {
			$('.infoGoods').show();
		}
		var tempSelector;
		var singleSelectionFlag = false;
		var isDefaultSku = true;
		// var isStandart = true;
		var numChoosed = 0;
		// container.find('#configuratorSelected').find('ul').find('li').remove();
		var currHeroImgSrc = "";

		$(document).on("mouseover","#itemOption_colors_master_parent_feat .configurator_param", function() {
		     $('div.pdp-buy-image img').attr({
		    		src: getColorPic($(this).attr("val")),
     				alt: $(this).attr("val")
			});
		});
		$(document).on("mouseout", "#itemOption_colors_master_parent_feat .configurator_param", function() {
			changeModelPicture (gallery_model_id);
		});
	
		for (i = 0; i < attributes.length; i++) {
			// if a standard model
			if (attributes[i].filter !== null && single_model_id !== null) {
				numChoosed++;
				if (attributes[i].mastername == "colors-master-parent-feat" && options.gallery !== null && withColor && attributes[i].filter != labels.none) {
					uniqueColor = attributes[i].filter;
			     	changeModelPicture(getColorModel(attributes[i].filter));
				} else if (withColor) {
					changeModelPicture("default");
					gallery_model_id = 0;
				}
			} else {
				default_model_id = 0;
				$('#itemOption_' + attributes[i].name).show();
				allChoosed = false;
				changeModelPicture("default");
				gallery_model_id = 0;
			}
		}
		container.find('#configuratorHeadingSelect').show();
		var selectedModelId = -1;
		var matchCount = 0;
		for (i = 0; i < models.length; i++) {
			var match = true;
			for (k = 0; k < models[i].attributes.length; k++) {
				if (attributes[models[i].attributes[k].id].filter !== null && models[i].attributes[k].value.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '') != attributes[models[i].attributes[k].id].filter.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g, '')) {
					match = false;
					break;
				}
			}
			if (match) {
				$("#modelItem_" + models[i].number).show();
				selectedModelId = single_model_id;
				matchCount++;
			}
			// This will assign the first selectedModel. After we exit the above
			// for loop, if it's still only one model
			// shown, that model will be passed to "changeModel" gallery
			// function.
			if (single_model === true && singleSelectionFlag === false) {
				selectedModelNumber = selected_model;
				singleSelectionFlag = true;
			}
		}
		if (single_model === true) {
			if (typeof(ProductInfoStruct.releaseList[0].modelList[selectedModelId]) !== "undefined" && typeof(ProductInfoStruct.releaseList[0].modelList[selectedModelId].imageSmallPath) !== "undefined" && ProductInfoStruct.releaseList[0].modelList[selectedModelId].imageSmallPath !== '') {
				changeModelPicture(selectedModelNumber);
				gallery_model_id = selectedModelId;
			} else {
				changeModelPicture("default");
				gallery_model_id = 0;
			}
			if (single_model == false && uniqueColor !== null) {
			
			     $('div.pdp-buy-image img').attr({
		    		src: getColorPic(uniqueColor),
     				alt: uniqueColor
				 });
			}
		}
		var noAccessory = null;
	//	if (models.length === 1 && !(typeof(ProductInfoStruct.releaseList[0].blocks.attributesBlock) !== "undefined" && !ProductInfoStruct.releaseList[0].blocks.attributesBlock)) {
	//		$('#configuratorHeadingSelect').hide();
	//	} else {
	//		if (typeof(ProductInfoStruct.releaseList[0].blocks) != "undefined" && !(typeof(ProductInfoStruct.releaseList[0].blocks.attributesBlock) !== "undefined" && !ProductInfoStruct.releaseList[0].blocks.attributesBlock)) $('#configuratorContent').show();
	//	}
	}

	function createResellersLink(selectedModelNumber) {
		/*
		 * This function calls Channel Intelligence's JavaScript API to generate
		 * the button link at the bottom of the product configurator. It
		 * requires a model number (sku) to be passed and also leverages the
		 * ciLocaleMap and rclocale global variables to pass the correct api
		 * parameters.
		 */

		$.getScript("http://seagate.links.channelintelligence.com/scripts/cii_CBL_DataService.asp?sSKU=" + selectedModelNumber + "&nRGID=" + embedRGID, function(data, textStatus, jqxhr) {
			// Remove any existing button
			$('.moreResellersBtn').remove();		
            var ciButtonScript = "cii_ShowCBLButton('" + selectedModelNumber + "', oCIIPrimaryLink, oCIIAlternateLink, 1, '" + embedRGID + "', CI_LinkID);"
			var ciButtonScriptOutput = eval(ciButtonScript);
			// If button is returned, build our own HTML for it
			if (ciButtonScriptOutput.length > 0) {
				var ciButtonHTML = "";
				for (var i = 0; i < 3; i++) {
					if (i === 2) {
						ciButtonScriptOutput[i] = ciButtonScriptOutput[i].replace('>', ' class="moreResellersBtn pdp-buy-resellers-more pull-right">');
					}
					ciButtonHTML += ciButtonScriptOutput[i];
				}
				ciButtonHTML += labels.show_more_resellers + "</a>";
				$.when($('.resellers-link').html(ciButtonHTML));
			}
		});
	}
	
    function showHideToggle(vendors_length){
    	if((attributes.length < 3 || models.length == 1) && vendors_length < 3 && (!stx_store || hidedisti)){
			$('#ToggleIcon').addClass("hide");
		} else {
			$('#ToggleIcon').removeClass("hide");
		}
    }
    
    function paramClickHandler(){
		if(param_clicked){
	   		$('.pdp-buy-toggle-content').collapse('show');		
	   		$('.pdp-buy-toggle a').removeClass('collapsed');
		 	$('.pdp-buy-toggle-content.collapse').addClass('in');
	        param_clicked = false;
        }
	}
	
	function getResellers(resellerCountryCode) {
        var counter = 0;
		var vendors = [];
		var resellersContent = "";
		wtb_vendors = 0;
		$.ajax({
			async : false,
			beforeSend: function(jqXHR, settings) {
				$('.resellersContent').empty();
			},
			url: '/ww/jsp/common/ajax.jsp?country=' + resellerCountryCode + '&sfdc=1',
			success: function(data) {  
				$('.modelAlert').empty();
				$('.resellersContent').empty();

				if($(data).find('DEALER').length > 0){
					$(data).find('DEALER').each(function(index) {
						var vendor = {
							'logo':  $(this).find('DEALER_LOGO').text(),
							'name': $(this).find('DEALER_NAME').text(),
							'buy_url': $(this).find('BUY_URL').text()
						}
						vendors.push(vendor);
					});
				
					if (typeof(vendors[0]) != 'undefined' ) {	
						wtb_vendors = vendors.length		
						for (i = 0; i < vendors.length; i++) {
							if(counter == 2){
									resellersContent += "</div><div class=\"pdp-buy-toggle-content collapse pdp-buy-resellers\">\n";
							}
							counter++;
							resellersContent += "<div class=\"buy-box clearfix\">\n";

              			  	resellersContent += "        <ul class=\"unstyled buy-box-table\">\n";
							resellersContent += "             <li><img height=\"40\" src=\"" + vendors[i].logo + "\" alt=\"" + vendors[i].name + "\"/></li><li><a class=\"button button-teal button-xs pull-right\" target=\"_blank\" href=\"" + vendors[i].buy_url + "\">" + labels.shop + "</a></li>";
							resellersContent += "        </ul>\n";
                			resellersContent += "</div>\n";	
                			
						}
						 resellersContent += "	</div>\n"; // .pdp-buy-resellers
						 $('.resellersContent').html( resellersContent );
						 paramClickHandler();
		        		 showHideToggle(wtb_vendors);
					}
					
				} else {
	//				$('.resellersTitle').remove();
				    $('.resellersContent').empty();
				    showHideToggle(wtb_vendors);
				}
			},
			error: function(){
	//		    $('.resellersTitle').remove();
				$('.resellersContent').empty();
				showHideToggle(wtb_vendors);
			}
		});
	}
	
	function getResellersByType(country_code) {
        
 	 	var wtbLocaleMap = {"wtb_countries":[
 	   {'wtb_country':'AE', 'locale':'ar-em'},
       {'wtb_country':'SG', 'locale':'en-sg'},
       {'wtb_country':'CN', 'locale':'zh-cn'},
       {'wtb_country':'US', 'locale':'en-us'},
       {'wtb_country':'TR', 'locale':'tr-tr'},
       {'wtb_country':'RU', 'locale':'ru-ru'},
       {'wtb_country':'ES', 'locale':'es-es'},
       {'wtb_country':'DE', 'locale':'de-de'},
       {'wtb_country':'FR', 'locale':'fr-fr'},
       {'wtb_country':'AU', 'locale':'en-au'},
       {'wtb_country':'BR', 'locale':'pt-br'},
       {'wtb_country':'GB', 'locale':'en-gb'},
       {'wtb_country':'IN', 'locale':'en-in'},
	   {'wtb_country':'CA', 'locale':'en-ca'},
	   {'wtb_country':'KR', 'locale':'ko-kr'},
       {'wtb_country':'TW', 'locale':'zh-tw'},
       {'wtb_country':'JP', 'locale':'ja-jp'},
       {'wtb_country':'IT', 'locale':'it-it'},
       {'wtb_country':'PL', 'locale':'pl-pl'},
       {'wtb_country':'ID', 'locale':'id-id'},
       {'wtb_country':'DK', 'locale':'en-dk'},
       {'wtb_country':'CZ', 'locale':'en-cz'},
       {'wtb_country':'HU', 'locale':'en-hu'},
       {'wtb_country':'RO', 'locale':'en-ro'},
       {'wtb_country':'SE', 'locale':'en-se'},
       {'wtb_country':'LT', 'locale':'en-lt'},
       {'wtb_country':'GB', 'locale':'en-ie'}
		]};
		
		for (var i = 0; i < wtbLocaleMap.wtb_countries.length; i++) {
			if (typeof(wtbLocaleMap.wtb_countries[i]) != 'undefined' && wtbLocaleMap.wtb_countries[i].wtb_country == country_code) {
			 	RGID = getRGID(wtbLocaleMap.wtb_countries[i].locale, 'xml');
			 	embedRGID = getRGID(wtbLocaleMap.wtb_countries[i].locale, 'embed');
			 	break;
			}else{
				RGID = 'noRGID';
			}
		 }
		 if(selected_model != null){
		 	if(RGID.length == 4){
		 	 	getChannelIntelligence(selected_model);
		 	}else{
		 		getResellers(country_code);
		 		paramClickHandler();
		 	}	 	
		 }
		 selectedCountryCode = country_code;
	}

}; // end of jQuery.fn.ProductConfigurator

jQuery.fn.extend({
	setSameHeight: function() {
		return this.each(function() {
			var t = $(this).find("table");
			var maxHeight = {};
			t.each(function() {
				var trs = $(this).find("tr");
				trs.each(function(i) {
					var tr = $(this);
					var height = tr.outerHeight();
					var mh = typeof(maxHeight[i]) == "undefined" ? 0 : maxHeight[i];
					if (height > mh) {
						maxHeight[i] = height;
					}
				});
			});
			var totalHeight = 0;
			t.each(function() {
				var $this = $(this);
				for (var key in maxHeight) {
					var mh = maxHeight[key];
					$this.find("tr").eq(key).css("height", mh + "px");
					totalHeight += mh;
				}
			});
			totalHeight = totalHeight / t.length + 20;
			if ('ontouchend' in document) {
				//alert('touch');
				totalHeight = totalHeight - 20;
			}
			$(this).css("height", totalHeight + "px");
			
		});
	}
});		

function getRGID(locale, type) {
	/*
	 * This function returns the RGID (Channel Intelligence code) for the
	 * locale that is passed. Assumes locale is in "en-us" format. It
	 * requires the ciLocaleMap global variable (which stores the codes) to
	 * exist. If no locale is passed it returns null.
	 */
	if (!locale) {
		return null;
	} else {
		for (var i = 0; i < ciLocaleMap.locales.length; i++) {
			if (typeof(ciLocaleMap.locales[i]) != 'undefined' && ciLocaleMap.locales[i].name.indexOf(locale) != -1) {
				if (type.indexOf('xml') != -1) {
					return ciLocaleMap.locales[i].xml;
				} else if (type.indexOf('embed') != -1) {
					return ciLocaleMap.locales[i].embed;
				} else {
					return "noRGID";
				}

			}
		}
		return "noRGID";
	}
}

function getDistributors(country) {
	if(country == "EM") country = "AE";
	//$('#DistiModal').load('/ww/distributorData?locale=' + locale + '&country=' + country + '&modal=bob .section', function() {});
	$('#distiContent').load('/ww/distributorData?locale=' + rclocale + '&country=' + country + '&modal=bob .section', function() {});
}

function updateDistributor(value) {
	$('#distributorsList').load('/ww/distributorData?country=' + value + '&locale=' + rclocale + ' .section', function() {
		activateCusel();
	});
}





function setStayInformedCountry(){

	if($('#StayInformedCountry option:selected').val() != UserCountryCode){
    	$('#StayInformedCountry option:selected').removeAttr('selected');
    	$('#StayInformedCountry option[value = '+ UserCountryCode +']').prop('selected',true);
    	$('#EloquaCountry').val($('#StayInformedCountry option:selected').attr('label'));
	} else{
		$('#EloquaCountry').val($('#StayInformedCountry option:selected').attr('label'));
	}
}

$('#StayInformedCountry').on('change', function () {
    var option_label = $('#StayInformedCountry :selected').attr('data-label');
    $('#EloquaCountry').val(option_label);
}).trigger('change');



/* This function simulates a form submit for usability testing purposes. Will need to refactored for production use */
var stayInformedTimeoutID;
$('#stay-informed').on("submit", function(event) {
	// Clear any previous error messages
	$('#stay-informed-first-name-error').removeClass('show');
	$('#stay-informed-last-name-error').removeClass('show');
	$('#stay-informed-email-error').removeClass('show');
	
	if(!($.trim($('#stay-informed-first-name').val()).length > 0)) {
		$('#stay-informed-first-name-error').addClass('show');
		return false;
	}
	if(!($.trim($('#stay-informed-last-name').val()).length > 0)) {
		$('#stay-informed-last-name-error').addClass('show');
		return false;
	}
	if(!($.trim($('#stay-informed-email').val()).length > 0)) {
		$('#stay-informed-email-error').addClass('show');
		return false;
	}
	var reMail = /^(?:[a-zA-Z0-9]+[_\-\+\.]?)*[a-zA-Z0-9]+@(?:([a-zA-Z0-9]+[_\-]?)*[a-zA-Z0-9]+\.)+([a-zA-Z]{2,})+$/;
	if($('#stay-informed-email').val().match(reMail) == null) {
		$('#stay-informed-email-error').addClass('show');
		return false;
	}
	  
	$('#stay-informed').hide();
	$('.stay-informed-content').append('<div class="pdp-buy-loading"><p>&nbsp;</p></div>');
	
    var frm = $('#stay-informed');
    
    
    

	if ( window.XDomainRequest ) {
      jQuery.ajaxTransport(function( s ) {
          if ( s.crossDomain && s.async ) {
              if ( s.timeout ) {
                  s.xdrTimeout = s.timeout;
                  delete s.timeout;
              }
              var xdr;
              return {
                  send: function( _, complete ) {
                      function callback( status, statusText, responses, responseHeaders ) {
                          xdr.onload = xdr.onerror = xdr.ontimeout = jQuery.noop;
                          xdr = undefined;
                          complete( status, statusText, responses, responseHeaders );
                      }
                      xdr = new XDomainRequest();
                      xdr.onload = function() {
                          callback( 200, "OK", { text: xdr.responseText }, "Content-Type: " + xdr.contentType );
                      };
                      xdr.onerror = function() {
                          callback( 404, "Not Found" );
                      };
                      xdr.onprogress = jQuery.noop;
                      xdr.ontimeout = function() {
                          callback( 0, "timeout" );
                      };
                      xdr.timeout = s.xdrTimeout || Number.MAX_VALUE;
                      xdr.open( s.type, s.url );
                      xdr.send( ( s.hasContent && s.data ) || null );
                  },
                  abort: function() {
                      if ( xdr ) {
                          xdr.onerror = jQuery.noop;
                          xdr.abort();
                      }
                  }
              };
          }
      });
	}

	$.ajax({
		type: frm.attr('method'),
		url: frm.attr('action'),
		data: frm.serialize(),
		complete: function (data, status) {
		}
	});		
	$('.stay-informed-content .pdp-buy-loading').addClass('done').html('<p>' + stayInformedSucessMsg + '</p>');
	stayInformedTimeoutID = window.setTimeout(function() {
		$(".stay-informed-open").click();
	}
	, 4000);
	return false;
});

/****
setSameElementHeight

Required variables:
e = selector value to find and set to the same height

This function finds every element that matches the passed selector string, saves the height of the tallest item, and then sets all of the matched
elements to the tallest height. It also temporarily resets the height of an element to auto in case content has been populated into an element
since the last time the function was run on it.

****/

function setSameElementHeight(e) {
	var tallest = 0;
	$(e).each(function() {
		$(this).css('height','auto'); // reset height in case an empty div has been populated
		if ($(this).height() > tallest) {
			tallest = $(this).height();
		} 
	});
	$(e).height(tallest);
}


/**** 
buildDistributors

Required variables:
ProductInfoStruct
.model-details, 

This function parses ProductInfoStruct to collect a list of DR Product IDs (pids). It then iterates through the columns of the specs table, gets the model
number and if it finds a matching pid in ProductInfoStruct it makes a call to the dr.jsp to fetch price and stock information (JSON). After the info is returned
it updates the display accordingly by adding price, stock status and add to cart buttons. Finally, it executes a set of same height functions to ensure a 
consistent display.

****/

function buildDistributors(pidModels){
	var countryCodeStr = $("#countryCodes").val();
	var countryCode = countryCodeStr.split('|');
	var countryStr = $("#countryNames").val();
	var countryName = countryStr.split('|');
	var countryCounter = 0;
	var distributorsHtml;;
	var country_default = $("#countryDefault").val();
	if(country_default == "EM") country_default = "AE";
	$('.model-details').each( function() {
		var mn = $(this).find('.model-number').html();
		if (pidModels.indexOf(mn) != -1){
			countryCounter++;
			distributorsHtml = "";
			distributorsHtml += '<style>.price-block {line-height:30px;}.buy select{width:200px; font-size:12px;}</style>';
	        distributorsHtml += "                            <select id=\"country" + countryCounter + "\" name=\"country" + countryCounter + "\" title=\"country\" tabindex=\"1\">\n";
		    for (var u = 0; u < countryName.length; u++) {
				if (country_default == countryCode[u]) {
					distributorsHtml += "<option value=" + countryCode[u] + " selected=\"selected\">" + countryName[u] + "</option>\n";
				} else {
					distributorsHtml += "<option value=" + countryCode[u] + ">" + countryName[u] + "</option>\n";
				}
    		}
         	distributorsHtml += "                            </select>\n";
            distributorsHtml += "                        <a href=\"#distiModal\" data-toggle=\"modal\" class=\"btn btn-large btn-primary add-to-cart\" id=\"configuratorFind" + countryCounter + "\">" + labels.find_a_distributor + "</a>\n";

           	
           	$(this).parent().find('.buy').html(distributorsHtml);
           	
           	$('#configuratorFind' + countryCounter).click( function(e) {
	        		var theCountry = $('#country' + countryCounter).val();
	            	getDistributors(theCountry);
            }); 
         }	    			
	 });
}



/**** 
getSpecsTablePrices

Required variables:
ProductInfoStruct
.model-details, .model-number, .buy, .price-block, and .stock-status elements

External Dependency:
/ww/jsp/common/drproduct.jsp
setSameElementHeight(e);
$(e).setSameHeight();

This function parses ProductInfoStruct to collect a list of DR Product IDs (pids). It then iterates through the columns of the specs table, gets the model
number and if it finds a matching pid in ProductInfoStruct it makes a call to the dr.jsp to fetch price and stock information (JSON). After the info is returned
it updates the display accordingly by adding price, stock status and add to cart buttons. Finally, it executes a set of same height functions to ensure a 
consistent display.

****/

function getSpecsTablePrices() {
    var coreModels = [];
	var pidModels = [];
	var pidArray = [];
	hideDisti = false;
	var thisModel = "";
	var countryCodeStr = $("#countryCodes").val();
	var countryCode = countryCodeStr.split('|');
	var countryStr = $("#countryNames").val();
	var countryName = countryStr.split('|');
	var countryCounter = 0;
	var distributorsHtml;;
	var country_default = $("#countryDefault").val();
    var POP = "value-add";
	var ecomm_locale = getEcommLocale();	
	var modelListLength = null;
	if (typeof(ProductInfoStruct.releaseList[0].modelList) != 'undefined') modelListLength = ProductInfoStruct.releaseList[0].modelList.length;
	if (typeof(ProductInfoStruct.releaseList[0].hidedisti) != 'undefined') hideDisti = ProductInfoStruct.releaseList[0].hidedisti;
	
		for ( var i = 0; i < modelListLength; i++) {
		    coreModels.push(ProductInfoStruct.releaseList[0].modelList[i].modelNumber);
			if(ProductInfoStruct.releaseList[0].modelList[i].drProductId.length > 0){
				pidArray.push(ProductInfoStruct.releaseList[0].modelList[i].drProductId);
			}else{
				pidModels.push(ProductInfoStruct.releaseList[0].modelList[i].modelNumber);
			}
		}
	
	if(country_default == "EM") country_default = "AE";
	if (ecomm_locale!="" && ProductInfoStruct.releaseList[0].blocks.buyBlock === true){  
		stx_store = true;
	} else { 
		if(hideDisti == false){
			buildDistributors(coreModels);
		}
		return;	
	}
	for (i = 0; i < ecommLocaleMap.ecommLocalesList.length; i++) {
		if (ecommLocaleMap.ecommLocalesList[i].ecommLocale == ecomm_locale){
			dr_locale = ecommLocaleMap.ecommLocalesList[i].drLocale;
			ecomm_currency = ecommLocaleMap.ecommLocalesList[i].currency;
		}
	}
	if (typeof(rcLocaleJS != 'undefined') && stx_store && typeof(ProductInfoStruct != 'undefined') && $('.product-specs-table-wrapper').length > 0){
		//console.log("pidArray: " + pidArray);
		
		if (pidArray.length > 0) {
			var drURL = "/ww/jsp/common/drproduct.jsp?drProductId=" + pidArray +'&drLocale=' + dr_locale + '&currency=' + ecomm_currency;
			//console.log("drURL: " + drURL);
			$.getJSON (drURL, function(data) { 
				$('.model-details').each( function() {
					var mn = $(this).find('.model-number').html();
					//console.log("mn: " + mn);
					
					for (var i = 0; i < modelListLength; i++) {
						if (ProductInfoStruct.releaseList[0].modelList[i].modelNumber == mn) {
							var currentPid = ProductInfoStruct.releaseList[0].modelList[i].drProductId;
							var backorderable = ProductInfoStruct.releaseList[0].modelList[i].backorderable;
							if (typeof(data.storeProduct) != "undefined") {
								for (var j = 0; j < data.storeProduct.length; j++) {
									if (data.storeProduct[j].pid == currentPid) {
										//console.log("price: " + data.storeProduct[j].discountedPrice + " stock: " + data.storeProduct[j].stockStatus );
										
										// Insert price
										$(this).parent().find('.price-block').html('<span class="price">' + data.storeProduct[j].discountedPrice) + '</span>';
										
										// Insert stock status and add to cart button
										var stockLabel = "";
										var buttonDisabled = false;
										if (data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_IN_STOCK" && data.storeProduct[j].preorderEnabled == "true" ) {
											stockLabel = labels.preorder;
										} else if (data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_IN_STOCK") {
											stockLabel = labels.instock;
										} else if (backorderable && (data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_BACKORDERED" || data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_OUT_OF_STOCK")) {
											stockLabel = labels.backorder;
										} else if (data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_BACKORDERED" || data.storeProduct[j].stockStatus == "PRODUCT_INVENTORY_OUT_OF_STOCK") {
											stockLabel = labels.notavailable;
											buttonDisabled = true;
										}
										
										
										
										$(this).parent().find('.stock-status').html(stockLabel);
										
										var buttonHTML = $('<a class="btn btn-large btn-primary add-to-cart">' + labels.add_to_cart + '</a>');
										if (buttonDisabled) {
											buttonHTML.addClass('disabled');
										} else {
											var drAddToCartURL = 'http://shop.seagate.com/store/sgateus/' + dr_locale + '/buy/productID.' + currentPid + '/quantity.1/Currency.' + ecomm_currency;
											buttonHTML.attr("href", drAddToCartURL);
										}
										if ($(this).parent().find('.buy').find("a.add-to-cart").length <= 0) {
											$(this).parent().find('.buy').append(buttonHTML);
										}
									}
									
								}
							}
							
						}
					}
				})
				setSameElementHeight(".buy");
				setSameElementHeight(".model-details");
				$("div.pstable-view").setSameHeight();
			});
		}
		if (pidArray.length == 0 || pidArray.length != modelListLength) { 
			if(hideDisti == false){
				buildDistributors(pidModels);
			}
		}
	}
}


$(document).ready(function () {

	$.getScript("http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4dc164cc63a08feb", function() {
		addthis.init();
	});	

   setStayInformedCountry(); // setting the default country in the form based on the user ip geolocation
  
    $('#EloquaCountry').val($('#StayInformedCountry :selected').attr('data-label')); // set eloqua country to the geolocation selected above.
	
	//Detect safari on windows to fix video float issue in pdp support
	var userAgent = navigator.userAgent.toLowerCase();
	
	var safari = userAgent.indexOf("webkit")!=-1 && userAgent.indexOf("chrome")==-1;
	var windows = userAgent.indexOf("win")!=-1;
	 
	if (safari && windows) {
		$("body").addClass("safari-windows");
	}

	// Click on the fake tab to trigger the hidden tab button
	$('.pdp-main-tab-dropdown-menu > li > a:first-of-type[href^=#]').on("click touchstart", function (e) {
		e.preventDefault();
		var tabURL = $(this).attr('href');
		$(this).parents('.pdp-tab').attr('id',tabURL.replace("#",""));
		//Display selected dropdown item
		$('.tab-to-drop-display').html($(this).html());
		$(this).siblings('a[data-toggle="tab"]').off('shown');
		$(this).siblings('a[data-toggle="tab"]').on('shown', function (e) {
			window.location.hash = tabURL;
			$(this).parents('li.dropdown').removeClass('open');
			var ecomm_locale = getEcommLocale();
			if (ecomm_locale != "") {
				$(".buy").height(85); // hard code height due to empty elements only applies to ecommerce locale	
			}
			setSameElementHeight(".buy");
			setSameElementHeight(".model-details");
			$(".editorial-content .pstable-cell").each(function() {
				$(this).css({
					"position": "absolute",
					"width": "100%"
				});
				var editorial_content = $(this).parents(".editorial-content");
				var h = parseFloat($(this).css("height")) + 16;
				editorial_content.css("height", h + "px");
			});
			$("div.pstable-view").setSameHeight();
		});
		$(this).siblings('a[data-toggle="tab"]').tab('show');
		
		equalHeightFilters();
		
		setSameElementHeight(".buy");
		setSameElementHeight(".model-details");
		$("div.pstable-view").setSameHeight();
		
		
	    if ($("#support-tab").attr("class") == "active"){
	    	$(".btn-group").show();
	    }
	    else
    	{
	    	$(".btn-group").hide();
    	}
	    
		equalHeightGroup($('.product-summary .m-item'));
		equalHeightGroup($('.pdp-related-products-col'));
    });
	
	// Initial load of tab if hash is present
	var hashLoad = false;
	if (window.location.hash) {
	    $('.nav-tabs a[href='+location.hash+']').click();
	    hashLoad = true;
	} 
	
	// Monitor hash changes
	window.onhashchange = function() {       
	    if (location.hash.length > 0) {  
	        $('.nav-tabs a[href='+location.hash+']').click();
	    } else {
			// if no hash show first tab (note first tab is actually 2nd anchor element)
			// added fake tab anchor tags, so the first tab now become 3rd one
			$('.nav-tabs a:eq(2)').tab('show');
			//Display selected dropdown item
			$('.tab-to-drop-display').html($('.nav-tabs a:eq(1)').html());
			// remove id otherwise it will remain the previous tab
			$('.pdp-tab').removeAttr("id");
	    }
	}		
	
	$('.pdp-main-tab-dropdown-menu a[data-toggle="tab"]').on('shown', function (e) {
		
	    //Equal height columns in Select your model section
		if (current_width > 767) {
			//equalHeightFilters();
		}
	})
	
	if ($(".m-carousel").length > 0) {
		//Photo gallery carousel
		$('.m-carousel').carousel();
		
		//Equal height carousel items so more space to swipe the video content
		equalHeightGroup($('.product-summary .m-item'));
	}
	
	//Bootstrap tooltip
	$('.tooltip-trigger').tooltip();

    function stopPropagation(e) {
        if (e.stopPropagation) 
            e.stopPropagation();
        else 
            e.cancelBubble = true;
    }
    
	//Stay informed
	$(".stay-informed-open").on('click touchstart', function (e) {
		stopPropagation(e);
		e.preventDefault();
    	$(".stay-informed-content").toggle();
		$(this).children(".ss-icon").toggle();
		$(this).toggleClass('active');
    });
	$(".stay-informed-close").on('click touchstart', function (e) {
		e.preventDefault();
		$(".stay-informed-open").click();
	});
	
	$(".stay-informed-content").on('click touchstart', function (e) {
		stopPropagation(e);
    });
	
	$(document).on('click touchstart', function (e) {
			stopPropagation(e);
        	if($('.stay-informed-content').is(':visible')){
        		$(".stay-informed-content").hide();
        		$(".stay-informed-open").children(".ss-icon").toggle();
        		$(".stay-informed-open").toggleClass('active');
        	}
    });
    

	//RWD header
	/**
	** Adding specific class see if it has dropdown menu or not.
	**/
	$(".nav-global li > a").each(function() {
        if ($(this).next().length > 0) {
				$(this).addClass("nav-global-with-drop");
		} else {
			$(this).addClass("nav-global-without-drop");
		};
    });
	
	/**
	** Convert hover to click when viewport width is larger than certain size
	**/
	var current_width = $(window).width();
	if (current_width > 767) {
		$(".nav-global li").hover(function() {
			//alert("768 hover");
			$(this).addClass('hover');
		}, function() {
			$(this).removeClass('hover');
		});
		
		//Equal height columns in Select your model section
		equalHeightFilters();
	}
	if (current_width <= 767) {
		$(".nav-global li a.nav-global-with-drop").on("click touchstart", function(e) {
			//alert("767 click");	
			e.preventDefault();
			$(this).parent("li").toggleClass('hover');
		});
	}
	
	equalHeightGroup($('.pdp-related-products-col'));
	
	/**
	** Re-convert hover to click when window is resized, and only if it's from lte 767px to gt 767px
	**/
	$(window).resize(function(){
		equalHeightFilters();
		equalHeightGroup($('.product-summary .m-item'));
		equalHeightGroup($('.pdp-related-products-col'));
		var resize_width = $(window).width();
		var change = false;
		if (current_width > 767 && resize_width <= 767) {
			change = true;
		}
		if (current_width <= 767 && resize_width > 767) {
			change = true;
		}
		if (resize_width != current_width && change) {
			current_width = resize_width;
			if (resize_width > 767) {
				$(".nav-global li a.nav-global-with-drop").off();
				$(".nav-global li").hover(function() {
					//alert("768 hover - resize");					
					$(this).addClass('hover');
				}, function() {
					$(this).removeClass('hover');
				});
			}
			if (resize_width <= 767) {
				//alert("767 resize");
				$(".nav-global li").off();
				$(".nav-global li a.nav-global-with-drop").on("click touchstart", function(e) {
					e.preventDefault();
					$(this).parent("li").toggleClass('hover');
				});
			}
		}
	});
	
	/**
	** Only one dropdown from search and navigation can be shown at one time.
	** Also add specific class names so that styles can be changed when each toggle is actived.
	**/	
	var nav_header_wrapper = $('.nav-header-wrapper');
	var nav_collapse_nav = $('.nav-global-wrapper');
	var nav_collapse_search = $('.nav-header-form-search');
	var btn_collapse_nav = $('a[data-target*="nav-global-wrapper"]');
	var btn_collapse_search = $('a[data-target*="nav-header-form-search"]');
	nav_collapse_nav.on('show hide', function () {
		nav_header_wrapper.toggleClass('nav-global-toggle');
		if (nav_collapse_search.hasClass("in")) {
			nav_collapse_search.collapse('hide');
			if (btn_collapse_search.hasClass("collapsed") == false) {
				btn_collapse_search.addClass("collapsed");
			}
		}
	});
	nav_collapse_search.on('show hide', function () {
		nav_header_wrapper.toggleClass('nav-search-toggle');
		if (nav_collapse_nav.hasClass("in")) {
			nav_collapse_nav.collapse('hide');
			if (btn_collapse_nav.hasClass("collapsed") == false) {
				btn_collapse_nav.addClass("collapsed");
			}
		}
	});
	
	// A value of checked for overviewContentRowHide suppresses the row from view. 
	// Such rows are displayed only upon application of the overviewContentRowAnchorTag as a URL parameter to the page. 
	$(".hideContentRow").hide();
	var achor = "";
	if (location.hash.length > 0)
	{
		achor = location.hash;
		achor = achor.substr(1);
		$("." + achor).show();
	}  
	
	var product_specs_table_selector = $("select.product-specs-table-selector");
	if (product_specs_table_selector.length > 0) {
		product_specs_table_selector.change(function() {
			var t = $(this);
			var sku_column = new Number(t.val());
			var specs_table = $(".pstable-view-right table.product-specs-table-content");
			specs_table.find("th").removeClass("show-phone-tt");
			specs_table.find("th:eq(" + sku_column + ")").addClass("show-phone-tt");
			specs_table.find("tr:not(.editorial-content)").each(function() {
				var tr = $(this);
				tr.find("td").removeClass("show-phone-tt");				
				tr.find("td:eq(" + sku_column + ")").addClass("show-phone-tt");
			});
		});
	}
	
	setSameElementHeight(".buy");
	setSameElementHeight(".model-details");
	$("div.pstable-view").setSameHeight();

	$(window).resize(function(){
		setSameElementHeight(".buy");
		setSameElementHeight(".model-details");
		$(".editorial-content .pstable-cell").each(function() {
			$(this).css({
				"position": "absolute",
				"width": "100%"
			});
			var editorial_content = $(this).parents(".editorial-content");
			var h = parseFloat($(this).css("height")) + 16;
			editorial_content.css("height", h + "px");
		});
		$("div.pstable-view").setSameHeight();
	});
	
	/*Set equal height when dropdown changes in mobile view*/
	$( ".product-specs-table-selector" ).change(function() {
		setSameElementHeight(".buy");
		setSameElementHeight(".model-details");
		$("div.pstable-view").setSameHeight();
	});
	
	getSpecsTablePrices();
	
});

function equalHeightFilters() {
	$(".pdp-buy-filter-molecule").each(function() {
		$(this).children("li:odd").each(function(i) {
			$(this).removeAttr('style');
			$(this).prev().removeAttr('style');				
			var odd = $(this);
			var even = $(this).prev();
			var odd_h = parseInt(odd.css("height"));
			var even_h = parseInt(even.css("height"));
			if (odd_h > even_h) {
				even.css("height", odd_h + "px");
				//odd.css("height", odd_h + "px");
			} else {
				//even.css("height", even_h + "px");
				odd.css("height", even_h + "px");
			}
		});
	});
}


function equalHeightGroup(group) {
	var groupMap = new Array();
	var radomId = uuid();
	var _this = this;
	groupMap[radomId] = new Array(group, group.length, 0);
	this.getMaxHeight = function(obj, uuid)
	{
		var info = groupMap[uuid];
		var group = info[0];
		var count = info[1];
		var tallest = info[2];
		if($(obj).height() > tallest) {
			tallest = $(obj).height();
		};
		count--;
		if (count == 0)
		{
			group.height(tallest);
		}
		else
		{
			info[1] = count;
			info[2] = tallest;
			groupMap.push(uuid, info);
		}
	};
	

	group.each(function() {
		$(this).removeAttr('style');
		var sImage = new SImage(this, radomId, _this.getMaxHeight);	
	});
}

function SImage(liElement, uuid, callback) {
    var img = new Image();
	var imgElement = $(liElement).find("img");
	if (typeof(imgElement) == "undefined")
	{
		callback(liElement, uuid);
		return;
	}
	var src = imgElement.attr("src");
	if (typeof(src) == "undefined")
	{
		callback(liElement, uuid);
		return;
	}

    var appname = navigator.appName.toLowerCase();
    if (appname.indexOf("netscape") == -1) {
       //ie
        img.onreadystatechange = function () {
            if (img.readyState == "complete") {
                callback(liElement, uuid);
            }
        };
    } else {
       //firefox
        img.onload = function () {
            if (img.complete == true) {
                callback(liElement, uuid);
            }
        }
    }

    this.img = img;
	this.img.src = src;	
}

function uuid(len, radix) {
	var CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
	var chars = CHARS, uuid = [], i;
	radix = radix || chars.length;

	if (len) {
	  // Compact form
	  for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random()*radix];
	} else {
	  // rfc4122, version 4 form
	  var r;

	  // rfc4122 requires these characters
	  uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';
	  uuid[14] = '4';

	  // Fill in random data.  At i==19 set the high bits of clock sequence as
	  // per rfc4122, sec. 4.1.5
	  for (i = 0; i < 36; i++) {
		if (!uuid[i]) {
		  r = 0 | Math.random()*16;
		  uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];
		}
	  }
	}

	return uuid.join('');
};

//ecommerce for product related and product accessories tab
var pdp_dr_locale ="";
var pdp_currentPid ="";
var pdp_ecomm_currency="";
var pdp_ecommLocale = "";
if(getCookie('ecommSessionCookie')!=null && getCookie('ecommSessionCookie')!=undefined && getCookie('ecommSessionCookie')!=""){		
	pdp_ecommLocale=getCookie('ecommSessionCookie');
}else if(getCookie('ecommLocaleCookie')!=null && getCookie('ecommLocaleCookie')!=undefined && getCookie('ecommLocaleCookie')!=""){
	pdp_ecommLocale=getCookie('ecommLocaleCookie');
}else{
	pdp_ecommLocale=rcLocaleJS;
}
if(ecommLocaleMap!=null || ecommLocaleMap!=undefined){
	for (var i = 0; i < ecommLocaleMap.ecommLocalesList.length; i++) {							
		if (ecommLocaleMap.ecommLocalesList[i].ecommLocale == pdp_ecommLocale){								
			pdp_dr_locale = ecommLocaleMap.ecommLocalesList[i].drLocale;
			pdp_ecomm_currency = ecommLocaleMap.ecommLocalesList[i].currency;
			break;
		}
	}
}
var gsaFeedFlag = false;
if(gsaEcommLocaleMap!=null || gsaEcommLocaleMap!=undefined ){
	for (var i = 0; i < gsaEcommLocaleMap.gsaEcommLocalesList.length; i++) {							
		if (gsaEcommLocaleMap.gsaEcommLocalesList[i].ecommLocale == pdp_ecommLocale){								
			gsaFeedFlag = true;
			break;
		}
	}
}
function addToCartPDP(drid) {
	
	var addToCartUrl = 'http://shop.seagate.com/store/sgateus/' + pdp_dr_locale + '/buy/productID.' + drid + '/quantity.1/Currency.' + pdp_ecomm_currency;
	document.location = addToCartUrl;
}

$(document).ready(function(){
	if($("#accessoriesTotalRecord")[0]!=undefined){
			if(gsaFeedFlag){
				var DR_preorder = $("#DR_preorder").val();
				var DR_instock = $("#DR_instock").val();
				var DR_outofstock = $("#DR_outofstock").val();
				var DR_backorder = $("#DR_backorder").val();
				var SG_preorder = $("#SG_preorder").val();
				var SG_instock = $("#SG_instock").val();
				var SG_outofstock = $("#SG_outofstock").val();
				var SG_backorder = $("#SG_backorder").val();
				var buttonclassenable = "btn btn-info";
				var buttonclassdisable = "btn btn-info disabled";				
				var drids="";
				var AddToCartText = $("#addToCartText").val();
				$("#ecommlocale").val(pdp_ecommLocale);
				$("div.pdp-accessories-row").each(function(i){
					var $this=$(this);

					var drid = $this.data("drid");
					if(drid!=null && drid!=""){
						drids += drid+"|";
					}			
				});
				if(drids.lastIndexOf("|")!=-1){
					drids = drids.substring(0, drids.length-1);
				}
				var PriceText=$("#PriceText").val();
				$.ajax({
					type : "POST",
					url : "/ww/jsp/accessories/refreshPrice.jsp",
					cache : false,
					data : {'drids':drids,'ecommlocale':pdp_ecommLocale},
					dataType:"json",
					success : function(msg) {
						$.each(msg,function(k,v){
							$.each(v,function(m,n){
							  var discounted = n.discounted;
							  var unitprice = n.unitprice;
							  var discountPrice = n.discountPrice;
							  var productid=n.productid;	
							  var stockstatus=n.stockstatus;
							  var preorderable = n.preorderable;
							  if(stockstatus!=null || stockstatus!=undefined){
								  stockstatus = stockstatus.toLowerCase();
							  }					      
							  var $div = $("div.pdp-accessories-row[data-drid='"+productid+"']");
							  var backorder = $div.data("backorder");
							  var $delPrice = $div.find("div.container.ds-btm > div.row-fluid > div.pdp-accessories-buy.span2 > del");
							  var $unitPrice = $div.find("div.container.ds-btm > div.row-fluid > div.pdp-accessories-buy.span2 > strong");
							  var $statusText = $div.find("div.container.ds-btm > div.row-fluid > div.pdp-accessories-buy.span2 > small");
							  var $ahref = $div.find("div.container.ds-btm > div.row-fluid > div.pdp-accessories-buy.span2 > a");
							  var btnAddToCartAction = ""; 								
							  if(discounted && (unitprice!=null ||unitprice!=undefined) ){
								  $delPrice.html(PriceText+": "+unitprice);
							  }else{
								  $delPrice.empty();
					    	  }
							  $unitPrice.html(PriceText+": "+discountPrice);
							  if(stockstatus == "product_inventory_in_stock" && preorderable){
								  $statusText.html(SG_preorder);
								  btnAddToCartAction = "javascript:addToCartPDP('"+productid+"');"; 								  
								  $ahref.addClass(buttonclassenable).attr("href",btnAddToCartAction).text(AddToCartText);
							  }else if(stockstatus == "product_inventory_in_stock"){
								  $statusText.html(DR_instock);
								  btnAddToCartAction = "javascript:addToCartPDP('"+productid+"');"; 								  
								  $ahref.addClass(buttonclassenable).attr("href",btnAddToCartAction).text(AddToCartText);
							  }else if(backorder && (stockstatus == "product_inventory_out_of_stock" || stockstatus == "product_inventory_backordered")){
								  $statusText.html(SG_backorder);
								  btnAddToCartAction = "javascript:addToCartPDP('"+productid+"');"; 								  
								  $ahref.addClass(buttonclassenable).attr("href",btnAddToCartAction).text(AddToCartText);
							  }else if(stockstatus == "product_inventory_out_of_stock" || stockstatus == "product_inventory_backordered"){
								  $statusText.html(SG_outofstock);
								  btnAddToCartAction = "javascript:void(0);"; 								  
								  $ahref.addClass(buttonclassdisable).attr("href",btnAddToCartAction).text(AddToCartText);
							  }
							});
						});
											
					}
				});
			}else{
				createAccessoriesResellersLinks();
			}
			
	}
	if($("div.pdp-feature-row.pdp-related-products")[0]!=undefined){	
		
		var isFoundEcommLocale = $("#isFoundEcommLocale").val();
		var drids="";
		var SG_addtocart = $("#SG_addtocart").val();
		var SG_instock = $("#SG_instock").val();
		var SG_preorder = $("#SG_preorder").val();
		var SG_backorder = $("#SG_backorder").val();
		var SG_notavailable = $("#SG_notavailable").val();
		var SG_outofstock =$("#SG_outofstock").val();
		var buttonclassenable = "btn btn-info";
		var buttonclassdisable = "btn btn-info disabled";
		if(isFoundEcommLocale!=undefined && isFoundEcommLocale=="true"){
			$("div.pdp-related-products-info.hiddenProductId").each(function(i){
				var $this=$(this);
				var drid = $this.data("drid");
				if(drid!=null && drid!=""){
					drids += drid+"|";
				}	
			});
			if(drids.lastIndexOf("|")!=-1){
				drids = drids.substring(0, drids.length-1);
			}
			
			$.ajax({
				type : "POST",
				url : "/ww/jsp/accessories/refreshPrice.jsp",
				cache : false,
				data : {'drids':drids,'ecommlocale':pdp_ecommLocale},
				dataType:"json",
				success : function(msg) {
					$.each(msg,function(k,v){
					    $.each(v,function(m,n){
					      var discounted = n.discounted;
						  var unitprice = n.unitprice;
						  var discountPrice = n.discountPrice;
						  var productid=n.productid;	
					      var stockstatus=n.stockstatus;
					      var preorderable = n.preorderable;
					      if(stockstatus!=null || stockstatus!=undefined){
					    	  stockstatus = stockstatus.toLowerCase();
					      }
					      var $div = $("div.pdp-related-products-info.hiddenProductId[data-drid='"+productid+"']");
					      var $p = $div.find("p.pdp-related-products-price");
					      var backorderable = $div.data("backorder");
						  if(stockstatus == "product_inventory_in_stock" && preorderable){
					    	  $p.append("<span class=\"price\">"+unitprice+"</span>")
					    	  	.append("<a href=\"javascript:addToCartPDP('"+productid+"');\" class='"+buttonclassenable+"'>"+SG_addtocart+"</a>")
					    	    .append("<br/>")
					    	    .append(SG_preorder);
					      }else if(stockstatus == "product_inventory_in_stock"){
					    	  $p.append("<span class=\"price\">"+unitprice+"</span>")
					    	  	.append("<a href=\"javascript:addToCartPDP('"+productid+"');\" class='"+buttonclassenable+"'>"+SG_addtocart+"</a>")
					    	  	.append("<br/>")
					    	  	.append(SG_instock);
					      }else if((stockstatus == "product_inventory_out_of_stock" || stockstatus=="product_inventory_backordered") && (backorderable!=undefined && backorderable=="1")){
					    	  $p.append("<span class=\"price\">"+unitprice+"</span>")
					    	  	.append("<a href=\"javascript:addToCartPDP('"+productid+"');\" class='"+buttonclassenable+"'>"+SG_addtocart+"</a>")
					    	    .append("<br/>")
					    	    .append(SG_backorder);
					      }else if(stockstatus == "product_inventory_out_of_stock" || stockstatus=="product_inventory_backordered"){
					    	  $p.append("<span class=\"price\">"+unitprice+"</span>")
					    	  	.append("<a onclick=\"javascript:return false;\" class='"+buttonclassdisable+"'>"+SG_addtocart+"</a>")
					    	    .append("<br/>")
					    	    .append(SG_outofstock);
					      }
					      				      
					    });
					});	
					
					// equal height the lis after ajax succeeded
					equalHeightGroup($('.pdp-related-products-col'));
				}
			});
		}else{
			createAccessoriesResellersLinksRelatedProducts();
		}
		
	}
	
});
